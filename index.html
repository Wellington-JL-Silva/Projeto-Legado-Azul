<html lang="pt-BR" style="--player-color: #323232;"><head><script>(function(firebaseConfig, initialAuthToken, appId) {
        window.__firebase_config = firebaseConfig;
        window.__initial_auth_token = initialAuthToken;
        window.__app_id = appId;
            })("\n{\n  \"apiKey\": \"AIzaSyCqyCcs2R2e7AegGjvFAwG98wlamtbHvZY\",\n  \"authDomain\": \"bard-frontend.firebaseapp.com\",\n  \"projectId\": \"bard-frontend\",\n  \"storageBucket\": \"bard-frontend.firebasestorage.app\",\n  \"messagingSenderId\": \"175205271074\",\n  \"appId\": \"1:175205271074:web:2b7bd4d34d33bf38e6ec7b\"\n}\n","eyJhbGciOiJSUzI1NiIsImtpZCI6ImY3NWQ2NDhiMmFkZjUwOWU5MTEzMWVlYjQ2MzRlYTBhNGUxOTg3ZDUiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BiYXJkLWZyb250ZW5kLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwiYXVkIjoiaHR0cHM6Ly9pZGVudGl0eXRvb2xraXQuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmlkZW50aXR5LmlkZW50aXR5dG9vbGtpdC52MS5JZGVudGl0eVRvb2xraXQiLCJ1aWQiOiIxMDQ3MzQ2NjU4ODA1NjEzMTExMyIsImlzcyI6ImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJhcmQtZnJvbnRlbmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGFpbXMiOnsiYXBwSWQiOiJjX2U2N2M2ZDEzM2QxYzYyNDlfbGVnYWRvLWF6dWwtZGF0YS1kcml2ZW4tZmluYWwtODUwIn0sImV4cCI6MTc1NjM4MDc0OSwiaWF0IjoxNzU2Mzc3MTQ5LCJhbGciOiJSUzI1NiJ9.l9zFSuHOJ6_K_Hdc2ijk1ppKAIpxkaKUTMUSPZw1wEcEVQgpL1lOX7hxeo2CpzmvpRLjLPkJiJf8gTqM_nzi2sD2SK-5Ucg8gdRp_S7zkxCfZgbRBbwWBAq9B5VHV1QmhBWQkaGKuNn8ESWZbdGswTZyAtunoTDf3j67tu2ypQSmOg-uIXwh7bQVAxgx5_xi_uvCwAMiHbfh5K3zMcH0yqkF7ss3jPtxEHhmBvRXDfi0HK5gNiCbdy5PWM871NTAjdM2K8ejSxrDFRG4bFbQ3oG5uZf1VevIDtd0pIMnaUE3XqVOmC2VqPjuLhqel7jz2aVkA5XBlDENiSRt9dB13w","c_e67c6d133d1c6249_legado-azul-data-driven-final-850")</script><script>(function() {
  // Ensure this script is executed only once
  if (window.firebaseAuthBridgeScriptLoaded) {
    return;
  }
  window.firebaseAuthBridgeScriptLoaded = true;

  let nextTokenPromiseId = 0;

  // Stores { resolve, reject } for ongoing token requests
  const pendingTokenPromises = {};

  // Listen for messages from the Host Application
  window.addEventListener('message', function(event) {

    const messageData = event.data;

  if (messageData && messageData.type === 'RESOLVE_NEW_FIREBASE_TOKEN') {
      const { success, token, error, promiseId } = messageData ?? {};
      if (pendingTokenPromises[promiseId]) {
        if (success) {
          pendingTokenPromises[promiseId].resolve(token);
        } else {
          pendingTokenPromises[promiseId].reject(new Error(error || 'Token refresh failed from host.'));
        }
        delete pendingTokenPromises[promiseId];
      }
    }
  });

  // Expose a function for the Generated App to request a new Firebase token
  window.requestNewFirebaseToken = function() {
    const currentPromiseId = nextTokenPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingTokenPromises[currentPromiseId] = { resolve, reject };
    });
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'REQUEST_NEW_FIREBASE_TOKEN',
        promiseId: currentPromiseId
      }, '*');
    } else {
      pendingTokenPromises[currentPromiseId].reject(new Error('No parent window to request token from.'));
      delete pendingTokenPromises[currentPromiseId];
    }
    return promise;
  };
})();</script><script>
let realOriginalGetUserMedia = null;
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
  realOriginalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
}

(function() {
  if (navigator.mediaDevices && navigator.mediaDevices.__proto__) {
    try {
      Object.defineProperty(navigator.mediaDevices.__proto__, 'getUserMedia', {
        get: function() {
          return undefined; // Or throw an error
        },
        configurable: false
      });
    } catch (error) {
      console.error("Error defining prototype getter:", error);
    }
  }
})();

(function() {
  const pendingMediaResolvers = {};
  let nextMediaPromiseId = 0;

  function requestMediaPermissions(constraints) {
    const mediaPromiseId = nextMediaPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingMediaResolvers[mediaPromiseId] = (granted) => {
        delete pendingMediaResolvers[mediaPromiseId];
        resolve(granted);
      };
    });

    window.parent.postMessage({
      type: 'requestMediaPermission',
      constraints: constraints,
      promiseId: mediaPromiseId,
    }, '*');

    return promise;
  }

  let originalGetUserMedia = realOriginalGetUserMedia;

  function interceptGetUserMedia() {
    if (navigator.mediaDevices) {
      Object.defineProperty(navigator.mediaDevices, 'getUserMedia', {
        value: function(constraints) {
          return requestMediaPermissions(constraints).then((granted) => {
            if (granted) {
              if (originalGetUserMedia) {
                return originalGetUserMedia(constraints);
              } else {
                throw new Error("Original getUserMedia not available.");
              }
            } else {
              throw new DOMException('Permission denied', 'NotAllowedError');
            }
          });
        },
        writable: false,
        configurable: false
      });
    }
  }

  interceptGetUserMedia();

  const observer = new MutationObserver(function(mutationsList, observer) {
    for (const mutation of mutationsList) {
      if (mutation.type === 'reconfigured' && mutation.name === 'getUserMedia' && mutation.object === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'attributes' && mutation.attributeName === 'getUserMedia' && mutation.target === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'childList' && mutation.addedNodes) {
        mutation.addedNodes.forEach(node => {
          if (node === navigator.mediaDevices) {
            interceptGetUserMedia();
          }
        });
      }
    }
  });

  function interceptSpeechRecognition() {
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      return;
    }

    const OriginalSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const SpeechRecognitionWrapper = function(...args) {
      const recognizer = new OriginalSpeechRecognition(...args);
      const originalStart = recognizer.start.bind(recognizer);

      recognizer.start = function() {
        requestMediaPermissions({ audio: true }).then(granted => {
          if (granted) {
            originalStart();
          } else {
            const errorEvent = new SpeechRecognitionErrorEvent('error');
            errorEvent.error = 'not-allowed'; // This is the standard error for permission denial.
            recognizer.dispatchEvent(errorEvent);
          }
        });
      };

      return recognizer;
    };

    SpeechRecognitionWrapper.prototype = OriginalSpeechRecognition.prototype;
    SpeechRecognitionWrapper.prototype.constructor = SpeechRecognitionWrapper;

    if (window.SpeechRecognition) {
      window.SpeechRecognition = SpeechRecognitionWrapper;
    }
    if (window.webkitSpeechRecognition) {
      window.webkitSpeechRecognition = SpeechRecognitionWrapper;
    }
  }

  interceptSpeechRecognition();

  window.addEventListener('message', function(event) {
    if (event.data) {
      if (event.data.type === 'resolveMediaPermission') {
        const { promiseId, granted } = event.data;
        if (pendingMediaResolvers[promiseId]) {
          pendingMediaResolvers[promiseId](granted);
        }
      }
    }
  });

})();</script><script>((function(modelInformation) {
  const originalFetch = window.fetch;
  // TODO: b/421908508 - Move these out of the script and match all generative AI model calls.
  let googleLlmBaseApiUrls = [
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':streamGenerateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageEditModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.ttsModelName + ':generateContent',
  ];
  modelInformation.deprecatedTextModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':streamGenerateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':generateContent',
    );
  });

  const pendingFetchResolvers = {};
  let nextPromiseId = 0;

  function handleStringInput(input, optionsArgument) {
    const actualUrl = input;
    const fetchCallArgs = [actualUrl, optionsArgument];
    const effectiveOptions = optionsArgument || {};
    const bodyForApiKeyCheck = effectiveOptions.body;
    const bodyForPostMessage = effectiveOptions.body;
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  function handleRequestInput(input, optionsArgument) {
    const actualUrl = input.url;
    const fetchCallArgs = [input, optionsArgument];
    const effectiveOptions = { method: input.method, headers: new Headers(input.headers) };
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (optionsArgument) {
      if (optionsArgument.method) effectiveOptions.method = optionsArgument.method;
      if (optionsArgument.headers) effectiveOptions.headers = new Headers(optionsArgument.headers);
      if ('body' in optionsArgument) {
        bodyForApiKeyCheck = optionsArgument.body;
        bodyForPostMessage = optionsArgument.body;
      } else {
        bodyForApiKeyCheck = undefined;
        bodyForPostMessage = input.body;
      }
    } else {
      bodyForApiKeyCheck = undefined;
      bodyForPostMessage = input.body;
    }
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  window.fetch = function(input, optionsArgument) {
    let actualUrl;
    let fetchCallArgs;
    let effectiveOptions = {};
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (typeof input === 'string') {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleStringInput(input, optionsArgument));
    } else if (input instanceof Request) {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleRequestInput(input, optionsArgument));
    } else {
      return originalFetch.apply(window, [input, optionsArgument]);
    }

    effectiveOptions.method = effectiveOptions.method || 'GET';
    if (!effectiveOptions.headers) {
      effectiveOptions.headers = new Headers();
    }


    if (typeof actualUrl === 'string' && googleLlmBaseApiUrls.some((url) => actualUrl.startsWith(url))) {
      let apiKeyIsNull = true;

      const regex = new RegExp("models/([^:]+)");
      const modelNameMatch = actualUrl.match(regex);
      const modelName = modelNameMatch ? modelNameMatch[1] : 'unspecified';


      try {
        const urlObject = new URL(actualUrl);  // Use URL object for robust parsing
        const apiKeyParam = urlObject.searchParams.get('key');
        if (apiKeyParam) {
          apiKeyIsNull = false;
        }
      } catch (e) {
        // Continue checks even if URL parsing fails
      }

      if (apiKeyIsNull && effectiveOptions.headers) {
        const h = new Headers(effectiveOptions.headers);
        const apiKeyHeaderValue = h.get('X-API-Key') || h.get('x-api-key');
        if (apiKeyHeaderValue) {
          apiKeyIsNull = false;
          return originalFetch.apply(window, fetchCallArgs);
        }
      }

      if (apiKeyIsNull && effectiveOptions.method && ['POST', 'PUT', 'PATCH'].includes(effectiveOptions.method.toUpperCase()) && typeof bodyForApiKeyCheck === 'string') {
        try {
          const bodyData = JSON.parse(bodyForApiKeyCheck);
          if (bodyData && bodyData.apiKey) {
            apiKeyIsNull = false;
            return originalFetch.apply(window, fetchCallArgs);
          }
        } catch (e) {
          // Ignore JSON parsing errors
        }
      }

      if(apiKeyIsNull) {
        const promiseId = nextPromiseId++;
        const promise = new Promise((resolve) => {
          pendingFetchResolvers[promiseId] = (resolvedResponse) => {
            delete pendingFetchResolvers[promiseId];
            resolve(resolvedResponse);
          };
        });

        let serializedBodyForPostMessage;
        if (typeof bodyForPostMessage === 'string' || bodyForPostMessage == null) {
            serializedBodyForPostMessage = bodyForPostMessage;
        } else if (bodyForPostMessage instanceof ReadableStream) {
            serializedBodyForPostMessage = null;
        } else {
            try {
                serializedBodyForPostMessage = JSON.stringify(bodyForPostMessage);
            } catch (e) {
                serializedBodyForPostMessage = null;
            }
        }

        const messageOptions = {
            method: effectiveOptions.method,
            headers: Object.fromEntries(new Headers(effectiveOptions.headers).entries()),
            body: serializedBodyForPostMessage
        };

        window.parent.postMessage({
          type: 'requestFetch',
          url: actualUrl,
          modelName: modelName,
          options: messageOptions,
          promiseId: promiseId,
        }, '*');

        return promise;
      }
      return originalFetch.apply(window, fetchCallArgs);
    }
    return originalFetch.apply(window, fetchCallArgs);
  };

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'resolveFetch') {
      const { promiseId, response } = event.data;
      if (pendingFetchResolvers[promiseId]) {
        try {
          const reconstructedResponse = new Response(response.body, {
            status: response.status,
            statusText: response.statusText,
            headers: new Headers(response.headers),
          });
          pendingFetchResolvers[promiseId](reconstructedResponse);
        } catch (error) {
          pendingFetchResolvers[promiseId](new Response(null, { status: 500, statusText: "Interceptor Response Reconstruction Error" }));
        }
      }
    }
  });

}))({"textModelName":"gemini-2.5-flash-preview-05-20","imageModelName":"imagen-3.0-generate-002","imageEditModelName":"gemini-2.5-flash-image-preview","videoModelName":"veo-2.0-generate-001","ttsModelName":"gemini-2.5-flash-preview-tts","deprecatedTextModelNames":["gemini-2.0-flash","gemini-2.5-flash-preview-04-17"]})</script><script>(function() {
  const originalConsoleLog = console.log;
  const originalConsoleError = console.error;

    /**
   * Normalizes an error event or a promise rejection reason into a structured error object.
   * @param {*} errorEventOrReason The error object or reason.
   * @return {object} Structured error data { message, name, stack }.
   */
  function getErrorObject(errorEventOrReason) {
    if (errorEventOrReason instanceof Error) {
      return {
        message: errorEventOrReason.message,
        name: errorEventOrReason.name,
        stack: errorEventOrReason.stack,
      };
    }
    // Fallback for non-Error objects.
    try {
      return {
        message: JSON.stringify(errorEventOrReason),
        name: 'UnknownErrorType',
        stack: null,
      };
    } catch (e) {
      return {
        message: String(errorEventOrReason),
        name: 'UnknownErrorTypeNonStringifiable',
        stack: null,
      };
    }
  }

  /**
   * Converts an array of arguments (from log/error) into a single string.
   * Handles Error objects specially to include their message and stack.
   * @param {Array<*>} args - Arguments passed to console methods.
   * @return {string} A string representation of the arguments.
   */
  function stringifyArgs(args) {
    return args
      .map((arg) => {
        if (arg instanceof Error) {
          const {message, stack} = arg;
          return `Error: ${message}${stack ? ('\nStack: ' + stack) : ''}`;
        }
        if (typeof arg === 'object' && arg !== null) {
          try {
            return JSON.stringify(arg);
          } catch (error) {
            return '[Circular Object]';
          }
        } else {
          return String(arg);
        }
      })
      .join(' ');
  }

  console.log = function(...args) {
    const logString = stringifyArgs(args);
    window.parent.postMessage({ type: 'log', message: logString }, '*');
    originalConsoleLog.apply(console, args);
  };

  console.error = function(...args) {
    let errorData;
    if (args.length > 0 && args[0] instanceof Error) {
      const err = args[0];
      // If the first arg is an Error, capture its details.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        ...getErrorObject(err),
        rawArgsString: stringifyArgs(args.slice(1)),
        timestamp: new Date().toISOString(),
      };
    } else {
      // If not an Error object, treat all args as a general error message.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        message: stringifyArgs(args),
        name: 'ConsoleLoggedError',
        stack: null,
        timestamp: new Date().toISOString(),
      };
    }
    window.parent.postMessage(errorData, '*');
    originalConsoleError.apply(console, args);
  };

  // Listen for global unhandled synchronous errors.
  window.addEventListener('error', function(event) {
    const errorDetails = event.error ? getErrorObject(event.error) : {
      message: event.message,
      name: 'GlobalError',
      stack: null,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    };

    window.parent.postMessage({
      type: 'error',
      source: 'global',
      ...errorDetails,
      message: errorDetails.message || event.message,
      timestamp: new Date().toISOString(),
    }, '*');
  });

  // Listen for unhandled promise rejections (asynchronous errors).
  window.addEventListener('unhandledrejection', function(event) {
    const errorDetails = getErrorObject(event.reason);

    window.parent.postMessage({
      type: 'error',
      source: 'unhandledrejection',
      ...errorDetails,
      message: errorDetails.message || 'Unhandled Promise Rejection',
      timestamp: new Date().toISOString(),
    }, '*');
  });

})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Projeto Legado Azul</title>
    <style>
        :root {
            --tile-size: 40px;
            --player-color: #3498db;
            --wall-color: #5D6D7E; 
            --floor-color: #ecf0f1;
            --dungeon-floor-color: #717171;
            --door-color: #f1c40f;
            --dungeon-entrance-color: #c0392b;
            --exit-reset-color: #1abc9c;
            --exit-next-color: #e74c3c;
            --save-crystal-color: #8e44ad;
            --awakening-crystal-color: #16A085;
            --teleport-crystal-color: #27AE60;
            
            /* Cores dos NPCs */
            --npc-purple-color: #9b59b6;
            --npc-red-color: #e74c3c;
            --npc-pink-color: #ff69b4;
            --npc-gray-color: #808080;
            --npc-green-color: #2ecc71;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; }
        #game-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; }
        
        #hud { padding: 5px 10px; background-color: #1a1a1a; color: white; width: 100%; flex-shrink: 0; z-index: 101; display: flex; justify-content: space-between; flex-wrap: wrap; border-bottom: 2px solid #fff; font-size: 14px; }
        
        #viewport { position: relative; overflow: hidden; width: 100%; flex-grow: 1; background-color: #333; }
        #game-container { position: relative; transition: transform 0.1s linear; }

        .tile { width: var(--tile-size); height: var(--tile-size); position: absolute; }
        .monster-sprite { width: var(--tile-size); height: var(--tile-size); position: absolute; z-index: 9; display: flex; justify-content: center; align-items: center; }
        .monster-triangle { width: 0; height: 0; border-left: calc(var(--tile-size) * 0.3) solid transparent; border-right: calc(var(--tile-size) * 0.3) solid transparent; border-bottom: calc(var(--tile-size) * 0.5) solid #c0392b; }
        #player { background-color: var(--player-color); width: calc(var(--tile-size) * 0.7); height: calc(var(--tile-size) * 0.7); border-radius: 50%; position: absolute; z-index: 10; margin: calc(var(--tile-size) * 0.15); }
        .npc { position: absolute; z-index: 9; width: calc(var(--tile-size) * 0.665); height: calc(var(--tile-size) * 0.665); border-radius: 50%; margin: calc(var(--tile-size) * 0.1675); }
        
        #controls-container { padding: 15px; background-color: #111; width: 100%; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; z-index: 100; }
        #d-pad { display: grid; grid-template-areas: ". up ." "left . right" ". down ."; width: 150px; height: 150px; gap: 2px; }
        .d-pad-btn { background-color: #444; color: white; border: 1px solid #666; font-size: 30px; cursor: pointer; user-select: none; }
        .d-pad-btn:active { background-color: #666; }
        #up-btn { grid-area: up; } #down-btn { grid-area: down; } #left-btn { grid-area: left; } #right-btn { grid-area: right; }
        #action-buttons { display: flex; flex-direction: column; gap: 15px; }
        .action-btn { padding: 15px 20px; font-size: 18px; background-color: #555; color: white; border: 1px solid #777; border-radius: 8px; cursor: pointer; }
        .ui-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95); color: white; z-index: 200; display: none; flex-direction: column; padding: 10px; overflow-y: auto;}
        
        #combat-screen { justify-content: space-between; align-items: center; }
        #combat-enemy-area, #combat-player-area { flex-basis: 40%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        #combat-enemy { width: 0; height: 0; border-left: 30px solid transparent; border-right: 30px solid transparent; border-bottom: 50px solid #e74c3c; margin-bottom: 10px; }
        #combat-player { background-color: var(--player-color); width: 50px; height: 50px; border-radius: 50%; margin-bottom: 10px; }
        .detailed-stats { border: 1px solid white; padding: 5px; width: 95%; font-size: 12px; background-color: rgba(0,0,0,0.3); }
        .stat-line { display: flex; justify-content: space-between; padding: 2px 5px; border-bottom: 1px solid #444; }
        .stat-line:last-child { border-bottom: none; }
        .stat-line span:first-child { font-weight: bold; margin-right: 5px; }

        #combat-menu { border-top: 2px solid white; padding-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .combat-btn { background-color: #333; color: white; border: 1px solid white; padding: 10px; text-align: center; cursor: pointer; }
        #message-log { padding: 10px; background-color: #111; color: white; width: 100%; height: 60px; border-top: 1px solid white; font-size: 14px; overflow-y: auto; flex-shrink: 0; }
        .menu-option, .inventory-item, .shop-item, .status-line, .rank-option, .equip-item, .craft-item, .elevator-option { padding: 10px; border: 1px solid #555; margin-bottom: 10px; cursor: pointer; }
        .menu-option:hover, .inventory-item:hover, .shop-item:hover, .rank-option:hover, .equip-item:hover, .craft-item:hover, .elevator-option:hover { background-color: #555; }
        .rank-option.disabled, .craft-item.disabled, .menu-option.disabled { background-color: #222; color: #666; cursor: not-allowed; }
        .status-line { display: flex; justify-content: space-between; align-items: center; }
        .status-upgrade-btn { background-color: #2ecc71; color: black; border: none; padding: 2px 8px; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .status-downgrade-btn { background-color: #e74c3c; color: white; border: none; padding: 2px 8px; cursor: pointer; font-weight: bold; }
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        #start-btn { padding: 15px 30px; font-size: 20px; cursor: pointer; background-color: #333; color: white; border: 2px solid white; margin-top: 20px; }
        .crystal-shape { clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); }
        #json-upload-label { display: block; text-align: center; padding: 10px; background-color: #555; border: 1px solid #777; cursor: pointer; margin-bottom: 10px; }
        #json-upload, #equip-json-upload { display: none; }
        .equip-slot { border: 2px dashed #777; padding: 10px; margin-bottom: 10px; min-height: 50px; cursor: pointer; }
        .equip-slot.filled { border-style: solid; border-color: #fff; }
        .equip-slot small, .equip-item small, .craft-item small { color: #aaa; font-size: 12px; }
        .equip-item { line-height: 1.4; }
        .oficina-tabs { display: flex; margin-bottom: 10px; border-bottom: 1px solid #fff; flex-wrap: wrap; }
        .oficina-tab { padding: 10px 15px; cursor: pointer; background-color: #333; }
        .oficina-tab.active { background-color: #555; border-bottom: 2px solid var(--player-color); }
        .oficina-content { display: none; }
        .oficina-content.active { display: block; }
        
        #combat-log-wrapper { width: 95%; flex-grow: 1; border: 1px solid white; background-color: rgba(0,0,0,0.5); padding: 10px; margin: 10px 0; display: flex; flex-direction: column; justify-content: space-between; }
        #combat-log-text { flex-grow: 1; overflow-y: auto; white-space: pre-wrap; font-size: 14px; }
        #combat-advance-btn { padding: 8px; background-color: #444; color: white; border: 1px solid #777; cursor: pointer; align-self: flex-end; margin-top: 5px; }

        #elevator-tabs { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; border-bottom: 1px solid #fff; padding-bottom: 10px; }
        .elevator-tab { padding: 8px 12px; cursor: pointer; background-color: #333; border: 1px solid #555; }
        .elevator-tab.active { background-color: #555; border-bottom-color: var(--player-color); }
        #elevator-floors { max-height: 300px; overflow-y: auto; }

        #color-changer-screen .stat-line { flex-direction: column; align-items: flex-start; }
        #color-changer-screen input[type="range"] { width: 100%; }
        #color-preview { width: 100%; height: 50px; border: 1px solid #fff; margin: 10px 0; }
        
        .shop-confirm-btn, .generic-confirm-btn {
            background-color: #2ecc71; color: white; border: none; padding: 5px 10px; 
            cursor: pointer; font-weight: bold; margin: 0 5px;
        }
        .shop-cancel-btn, .generic-cancel-btn {
            background-color: #e74c3c; color: white; border: none; padding: 5px 10px; 
            cursor: pointer; font-weight: bold; margin: 0 5px;
        }

        #update-screen { padding: 15px; }
        .json-editor-container { margin-bottom: 20px; }
        .json-editor-container label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--player-color); }
        .json-editor-textarea {
            width: 100%;
            height: 250px;
            background-color: #1a1a1a;
            color: #f0f0f0;
            border: 1px solid #555;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            padding: 10px;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: scroll;
        }
        #download-updated-html-btn {
            background-color: var(--player-color);
            color: white;
            font-weight: bold;
        }
    </style>
<script id="save-data-script">window.SAVED_GAME_DATA = {"player":{"x":2,"y":2,"nivel":150,"xp":10584,"xpParaNivel":15000,"gemas":11055,"playerColor":"#3498db","pontosDeAtributo":24,"rank":5,"prestigio":0,"totalXpGanho":1136731,"andarMaisAlto":155,"equipamentos":{"Arma":"eq-1756313594738","Armadura":"eq-1756344218819","Manto":"eq-1756317201913","Bota":"eq-1756326933613","Anel":"eq-1724783160001","Luva":"eq-1756368707616","Escudo":"eq-1756317212109","Cordão":"eq-1724783160002"},"inventarioEquipamentos":[{"id":"eq-1724783160001","baseId":"anel_mithril","level":8,"slotsHabilidades":4,"habilidades":[]},{"id":"eq-1724783160002","baseId":"cordao_mithril","level":8,"slotsHabilidades":3,"habilidades":[]},{"id":"eq-1756313594738","baseId":"cajado_mithril","level":7,"slotsHabilidades":5,"habilidades":[]},{"id":"eq-1756317201913","baseId":"manto_mithril","level":3,"slotsHabilidades":1,"habilidades":[]},{"id":"eq-1756317212109","baseId":"escudo_mithril","level":2,"slotsHabilidades":1,"habilidades":[]},{"id":"eq-1756326933613","baseId":"bota_mithril","level":2,"slotsHabilidades":2,"habilidades":[]},{"id":"eq-1756344218819","baseId":"armadura_mithril","level":2,"slotsHabilidades":5,"habilidades":[]},{"id":"eq-1756368707616","baseId":"luva_mithril","level":2,"slotsHabilidades":1,"habilidades":[]}],"atributos":{"vidaMax":138,"vidaAtual":150,"velocidade":82,"forcaFisica":5,"inteligencia":276,"resistenciaFisica":138,"resistenciaMagica":138,"rouboDeVidaPercentual":0},"inventario":[{"itemId":1,"quantidade":0},{"itemId":5,"quantidade":0},{"itemId":2,"quantidade":35}]},"masmorraAtual":{"nivel":0,"monstros":[],"mapa":null},"gameStateStack":["CASA"]};</script><script id="save-data-script">window.SAVED_GAME_DATA = {"player":{"x":2,"y":2,"nivel":206,"xp":13768,"xpParaNivel":20600,"gemas":1382384,"playerColor":"#323232","pontosDeAtributo":516,"rank":5,"prestigio":30,"totalXpGanho":2125268,"andarMaisAlto":480,"equipamentos":{"Arma":"eq-1756313594738","Armadura":"eq-1756344218819","Manto":"eq-1756317201913","Bota":"eq-1756326933613","Anel":"eq-1724783160001","Luva":"eq-1756368707616","Escudo":"eq-1756317212109","Cordão":"eq-1724783160002"},"inventarioEquipamentos":[{"id":"eq-1724783160001","baseId":"anel_mithril","level":15,"slotsHabilidades":4,"habilidades":[]},{"id":"eq-1724783160002","baseId":"cordao_mithril","level":15,"slotsHabilidades":3,"habilidades":[]},{"id":"eq-1756313594738","baseId":"cajado_mithril","level":15,"slotsHabilidades":5,"habilidades":[]},{"id":"eq-1756317201913","baseId":"manto_mithril","level":15,"slotsHabilidades":1,"habilidades":[]},{"id":"eq-1756317212109","baseId":"escudo_mithril","level":15,"slotsHabilidades":1,"habilidades":[]},{"id":"eq-1756326933613","baseId":"bota_mithril","level":15,"slotsHabilidades":2,"habilidades":[]},{"id":"eq-1756344218819","baseId":"armadura_mithril","level":15,"slotsHabilidades":5,"habilidades":[]},{"id":"eq-1756368707616","baseId":"luva_mithril","level":15,"slotsHabilidades":1,"habilidades":[]}],"atributos":{"vidaMax":1000,"vidaAtual":1380,"velocidade":600,"forcaFisica":600,"inteligencia":1000,"resistenciaFisica":1000,"resistenciaMagica":1000,"rouboDeVidaPercentual":0},"inventario":[{"itemId":1,"quantidade":0},{"itemId":5,"quantidade":0},{"itemId":2,"quantidade":32}]},"masmorraAtual":{"nivel":480,"mapa":[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,11,0,0,0,0,0,0,0,0,0,0,0,7,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,8,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],"monstros":[{"nome":"Triângulo Mágico","nivel":482,"pontosTotais":2478,"tipoAtaque":"magico","cor":"#9b59b6","atributos":{"vidaMax":991,"velocidade":247,"forcaFisica":74,"inteligencia":546,"resistenciaFisica":74,"resistenciaMagica":546,"vidaAtual":991},"x":8,"y":9,"id":"m-1759361143434-0"},{"nome":"Triângulo Físico","nivel":482,"pontosTotais":2463,"tipoAtaque":"fisico","cor":"#c0392b","atributos":{"vidaMax":985,"velocidade":246,"forcaFisica":543,"inteligencia":73,"resistenciaFisica":543,"resistenciaMagica":73,"vidaAtual":985},"x":9,"y":11,"id":"m-1759361143434-1"},{"nome":"Triângulo Bruto","nivel":481,"pontosTotais":2465,"tipoAtaque":"fisico","cor":"#C8A2C8","atributos":{"vidaMax":986,"velocidade":246,"forcaFisica":544,"inteligencia":73,"resistenciaFisica":73,"resistenciaMagica":543,"vidaAtual":986},"x":8,"y":3,"id":"m-1759361143434-2"},{"nome":"Triângulo Mágico","nivel":482,"pontosTotais":2456,"tipoAtaque":"magico","cor":"#9b59b6","atributos":{"vidaMax":982,"velocidade":245,"forcaFisica":73,"inteligencia":542,"resistenciaFisica":73,"resistenciaMagica":541,"vidaAtual":982},"x":1,"y":5,"id":"m-1759361143434-3"},{"nome":"Triângulo Bruto","nivel":480,"pontosTotais":2452,"tipoAtaque":"fisico","cor":"#C8A2C8","atributos":{"vidaMax":980,"velocidade":245,"forcaFisica":541,"inteligencia":73,"resistenciaFisica":73,"resistenciaMagica":540,"vidaAtual":980},"x":3,"y":12,"id":"m-1759361143434-4"},{"nome":"Triângulo Encantado","nivel":482,"pontosTotais":2464,"tipoAtaque":"magico","cor":"#f1c40f","atributos":{"vidaMax":985,"velocidade":246,"forcaFisica":73,"inteligencia":543,"resistenciaFisica":544,"resistenciaMagica":73,"vidaAtual":985},"x":10,"y":8,"id":"m-1759361143434-5"},{"nome":"Triângulo Encantado","nivel":480,"pontosTotais":2455,"tipoAtaque":"magico","cor":"#f1c40f","atributos":{"vidaMax":982,"velocidade":245,"forcaFisica":73,"inteligencia":541,"resistenciaFisica":541,"resistenciaMagica":73,"vidaAtual":982},"x":5,"y":7,"id":"m-1759361143434-6"},{"nome":"Triângulo Bruto","nivel":481,"pontosTotais":2469,"tipoAtaque":"fisico","cor":"#C8A2C8","atributos":{"vidaMax":987,"velocidade":246,"forcaFisica":544,"inteligencia":74,"resistenciaFisica":74,"resistenciaMagica":544,"vidaAtual":987},"x":3,"y":9,"id":"m-1759361143434-7"},{"nome":"Triângulo Mágico","nivel":481,"pontosTotais":2466,"tipoAtaque":"magico","cor":"#9b59b6","atributos":{"vidaMax":986,"velocidade":246,"forcaFisica":73,"inteligencia":544,"resistenciaFisica":73,"resistenciaMagica":544,"vidaAtual":986},"x":8,"y":1,"id":"m-1759361143434-8"},{"nome":"Triângulo Bruto","nivel":482,"pontosTotais":2461,"tipoAtaque":"fisico","cor":"#C8A2C8","atributos":{"vidaMax":984,"velocidade":246,"forcaFisica":543,"inteligencia":73,"resistenciaFisica":73,"resistenciaMagica":542,"vidaAtual":984},"x":10,"y":9,"id":"m-1759361143434-10"},{"nome":"Triângulo Encantado","nivel":482,"pontosTotais":2478,"tipoAtaque":"magico","cor":"#f1c40f","atributos":{"vidaMax":991,"velocidade":247,"forcaFisica":74,"inteligencia":546,"resistenciaFisica":546,"resistenciaMagica":74,"vidaAtual":991},"x":6,"y":3,"id":"m-1759361143434-11"},{"nome":"Triângulo Bruto","nivel":480,"pontosTotais":2468,"tipoAtaque":"fisico","cor":"#C8A2C8","atributos":{"vidaMax":987,"velocidade":246,"forcaFisica":544,"inteligencia":74,"resistenciaFisica":74,"resistenciaMagica":543,"vidaAtual":987},"x":13,"y":5,"id":"m-1759361143434-12"},{"nome":"Triângulo Encantado","nivel":481,"pontosTotais":2469,"tipoAtaque":"magico","cor":"#f1c40f","atributos":{"vidaMax":987,"velocidade":246,"forcaFisica":74,"inteligencia":544,"resistenciaFisica":544,"resistenciaMagica":74,"vidaAtual":987},"x":7,"y":9,"id":"m-1759361143434-14"},{"nome":"Triângulo Físico","nivel":482,"pontosTotais":2474,"tipoAtaque":"fisico","cor":"#c0392b","atributos":{"vidaMax":989,"velocidade":247,"forcaFisica":545,"inteligencia":74,"resistenciaFisica":545,"resistenciaMagica":74,"vidaAtual":989},"x":8,"y":11,"id":"m-1759361143434-15"},{"nome":"Triângulo Bruto","nivel":482,"pontosTotais":2480,"tipoAtaque":"fisico","cor":"#C8A2C8","atributos":{"vidaMax":992,"velocidade":248,"forcaFisica":546,"inteligencia":74,"resistenciaFisica":74,"resistenciaMagica":546,"vidaAtual":992},"x":10,"y":13,"id":"m-1759361143434-16"},{"nome":"Triângulo Encantado","nivel":481,"pontosTotais":2459,"tipoAtaque":"magico","cor":"#f1c40f","atributos":{"vidaMax":983,"velocidade":245,"forcaFisica":73,"inteligencia":542,"resistenciaFisica":543,"resistenciaMagica":73,"vidaAtual":983},"x":2,"y":12,"id":"m-1759361143434-17"},{"nome":"Triângulo Encantado","nivel":481,"pontosTotais":2452,"tipoAtaque":"magico","cor":"#f1c40f","atributos":{"vidaMax":980,"velocidade":245,"forcaFisica":73,"inteligencia":540,"resistenciaFisica":541,"resistenciaMagica":73,"vidaAtual":980},"x":10,"y":6,"id":"m-1759361143434-18"},{"nome":"Triângulo Mágico","nivel":480,"pontosTotais":2448,"tipoAtaque":"magico","cor":"#9b59b6","atributos":{"vidaMax":979,"velocidade":244,"forcaFisica":73,"inteligencia":540,"resistenciaFisica":73,"resistenciaMagica":539,"vidaAtual":979},"x":10,"y":11,"id":"m-1759361143434-19"},{"nome":"Triângulo Encantado","nivel":481,"pontosTotais":2471,"tipoAtaque":"magico","cor":"#f1c40f","atributos":{"vidaMax":988,"velocidade":247,"forcaFisica":74,"inteligencia":544,"resistenciaFisica":544,"resistenciaMagica":74,"vidaAtual":988},"x":4,"y":6,"id":"m-1759361143434-20"},{"nome":"Triângulo Físico","nivel":480,"pontosTotais":2466,"tipoAtaque":"fisico","cor":"#c0392b","atributos":{"vidaMax":986,"velocidade":246,"forcaFisica":544,"inteligencia":73,"resistenciaFisica":544,"resistenciaMagica":73,"vidaAtual":986},"x":12,"y":6,"id":"m-1759361143434-21"},{"nome":"Triângulo Mágico","nivel":482,"pontosTotais":2456,"tipoAtaque":"magico","cor":"#9b59b6","atributos":{"vidaMax":982,"velocidade":245,"forcaFisica":73,"inteligencia":542,"resistenciaFisica":73,"resistenciaMagica":541,"vidaAtual":982},"x":11,"y":5,"id":"m-1759361143434-22"},{"nome":"Triângulo Encantado","nivel":480,"pontosTotais":2452,"tipoAtaque":"magico","cor":"#f1c40f","atributos":{"vidaMax":980,"velocidade":245,"forcaFisica":73,"inteligencia":540,"resistenciaFisica":541,"resistenciaMagica":73,"vidaAtual":980},"x":5,"y":3,"id":"m-1759361143434-24"},{"nome":"Triângulo Físico","nivel":480,"pontosTotais":2456,"tipoAtaque":"fisico","cor":"#c0392b","atributos":{"vidaMax":982,"velocidade":245,"forcaFisica":542,"inteligencia":73,"resistenciaFisica":541,"resistenciaMagica":73,"vidaAtual":982},"x":5,"y":3,"id":"m-1759361143434-25"},{"nome":"Triângulo Bruto","nivel":481,"pontosTotais":2458,"tipoAtaque":"fisico","cor":"#C8A2C8","atributos":{"vidaMax":983,"velocidade":245,"forcaFisica":542,"inteligencia":73,"resistenciaFisica":73,"resistenciaMagica":542,"vidaAtual":983},"x":11,"y":5,"id":"m-1759361143434-26"},{"nome":"Triângulo Mágico","nivel":481,"pontosTotais":2450,"tipoAtaque":"magico","cor":"#9b59b6","atributos":{"vidaMax":980,"velocidade":245,"forcaFisica":73,"inteligencia":540,"resistenciaFisica":73,"resistenciaMagica":539,"vidaAtual":980},"x":9,"y":6,"id":"m-1759361143434-27"},{"nome":"Triângulo Encantado","nivel":480,"pontosTotais":2455,"tipoAtaque":"magico","cor":"#f1c40f","atributos":{"vidaMax":982,"velocidade":245,"forcaFisica":73,"inteligencia":541,"resistenciaFisica":541,"resistenciaMagica":73,"vidaAtual":982},"x":13,"y":10,"id":"m-1759361143434-28"},{"nome":"Triângulo Físico","nivel":482,"pontosTotais":2464,"tipoAtaque":"fisico","cor":"#c0392b","atributos":{"vidaMax":985,"velocidade":246,"forcaFisica":544,"inteligencia":73,"resistenciaFisica":543,"resistenciaMagica":73,"vidaAtual":985},"x":1,"y":13,"id":"m-1759361143434-29"},{"nome":"Triângulo Bruto","nivel":482,"pontosTotais":2466,"tipoAtaque":"fisico","cor":"#C8A2C8","atributos":{"vidaMax":986,"velocidade":246,"forcaFisica":544,"inteligencia":73,"resistenciaFisica":73,"resistenciaMagica":544,"vidaAtual":986},"x":3,"y":5,"id":"m-1759361143434-30"},{"nome":"Triângulo Físico","nivel":482,"pontosTotais":2472,"tipoAtaque":"fisico","cor":"#c0392b","atributos":{"vidaMax":988,"velocidade":247,"forcaFisica":545,"inteligencia":74,"resistenciaFisica":544,"resistenciaMagica":74,"vidaAtual":988},"x":4,"y":4,"id":"m-1759361143434-31"}]},"gameStateStack":["CASA"]};</script></head>
<body>
    <div id="start-screen" style="display: none;">
        <h1>Projeto Legado Azul</h1>
        <p>Aguardando o comando do Criador...</p>
        <button id="start-btn">Iniciar Jogo</button>
    </div>

    <div id="game-wrapper">
        <div id="hud">
            <div id="hud-level">Nível: 206</div>
            <div id="hud-hp">HP: 1380/1380</div>
            <div id="hud-xp">XP: 13768/20600</div>
            <div id="hud-xp-multiplier">XP Mult: 20.0x</div>
        </div>
        <div id="viewport">
            <div id="game-container" style="transform: translate(-174.5px, -24px);"><div id="player" style="left: 360px; top: 240px; background-color: rgb(50, 50, 50);"></div><div class="tile" style="left: 0px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 80px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 120px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 160px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 200px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 240px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 280px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 320px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 360px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 400px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 440px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 480px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 520px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 560px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 600px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 640px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 680px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 720px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 760px; top: 0px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 40px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 40px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 40px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 80px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 80px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 80px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 80px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 240px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 280px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 320px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 360px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 400px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 440px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 480px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 520px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 560px; top: 80px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 80px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 80px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 80px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 80px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 80px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 120px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 120px; background-color: var(--wall-color);"></div><div class="tile" style="left: 240px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 120px; background-color: var(--wall-color);"></div><div class="tile" style="left: 560px; top: 120px; background-color: var(--floor-color);"></div><div class="npc" style="left: 600px; top: 120px; background-color: var(--npc-green-color);"></div><div class="tile" style="left: 600px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 120px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 120px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 160px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 160px; background-color: var(--wall-color);"></div><div class="tile" style="left: 240px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 160px; background-color: var(--wall-color);"></div><div class="tile" style="left: 560px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 160px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 160px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 200px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 200px; background-color: var(--wall-color);"></div><div class="tile" style="left: 560px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 200px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 200px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 240px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 240px; background-color: var(--floor-color);"></div><div class="tile crystal-shape" style="left: 360px; top: 240px; background-color: var(--awakening-crystal-color);"></div><div class="tile" style="left: 400px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 240px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 240px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 280px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 280px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 280px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 320px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 320px; background-color: var(--floor-color);"></div><div class="npc" style="left: 80px; top: 320px; background-color: var(--npc-gray-color);"></div><div class="tile" style="left: 80px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 320px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 320px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 360px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 360px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 360px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 400px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 400px; background-color: var(--floor-color);"></div><div class="tile crystal-shape" style="left: 360px; top: 400px; background-color: var(--dungeon-entrance-color);"></div><div class="tile" style="left: 400px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 400px; background-color: var(--floor-color);"></div><div class="npc" style="left: 680px; top: 400px; background-color: var(--npc-purple-color);"></div><div class="tile" style="left: 680px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 400px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 400px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 440px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 440px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 440px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 480px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 480px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 480px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 520px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 520px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 520px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 560px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 560px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 560px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 600px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 600px; background-color: var(--floor-color);"></div><div class="npc" style="left: 80px; top: 600px; background-color: var(--npc-pink-color);"></div><div class="tile" style="left: 80px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 600px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 600px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 640px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 80px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 120px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 160px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 200px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 240px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 280px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 320px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 360px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 400px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 440px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 480px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 520px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 560px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 600px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 640px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 680px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 720px; top: 640px; background-color: var(--floor-color);"></div><div class="tile" style="left: 760px; top: 640px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 80px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 120px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 160px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 200px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 240px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 280px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 320px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 360px; top: 680px; background-color: var(--door-color);"></div><div class="tile" style="left: 400px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 440px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 480px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 520px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 560px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 600px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 640px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 680px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 720px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 760px; top: 680px; background-color: var(--wall-color);"></div><div class="tile" style="left: 0px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 40px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 80px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 120px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 160px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 200px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 240px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 280px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 320px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 360px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 400px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 440px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 480px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 520px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 560px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 600px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 640px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 680px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 720px; top: 720px; background-color: var(--wall-color);"></div><div class="tile" style="left: 760px; top: 720px; background-color: var(--wall-color);"></div></div>
        </div>
        <div id="message-log">Save (JSON) baixado!</div>
        <div id="controls-container">
            <div id="d-pad">
                <button id="up-btn" class="d-pad-btn">▲</button><button id="left-btn" class="d-pad-btn">◄</button>
                <button id="right-btn" class="d-pad-btn">►</button><button id="down-btn" class="d-pad-btn">▼</button>
            </div>
            <div id="action-buttons">
                <button id="action1-btn" class="action-btn">Ação</button><button id="menu-btn" class="action-btn">Menu</button>
            </div>
        </div>
    </div>

    <!-- Telas da UI -->
    <div id="combat-screen" class="ui-screen" style="display: none;">
        <div id="combat-enemy-area">
            <div id="combat-enemy" style="border-bottom-color: rgb(200, 162, 200);"></div>
            <div class="detailed-stats">
                <div class="stat-line"><span>Lvl:</span><span id="enemy-lvl">481</span></div>
                <div class="stat-line"><span>HP:</span><span id="enemy-hp">-103/986</span></div>
                <div class="stat-line"><span>Ata:</span><span id="enemy-ata">544</span></div>
                <div class="stat-line"><span>Def:</span><span id="enemy-def">73</span></div>
                <div class="stat-line"><span>Esp Atq:</span><span id="enemy-esp-atq">73</span></div>
                <div class="stat-line"><span>Esp Def:</span><span id="enemy-esp-def">543</span></div>
                <div class="stat-line"><span>Spd:</span><span id="enemy-spd">246</span></div>
            </div>
        </div>
        <div id="combat-player-area">
            <div id="combat-player" style="background-color: rgb(50, 50, 50);"></div>
            <div class="detailed-stats">
                <div class="stat-line"><span>Lvl:</span><span id="player-lvl">206</span></div>
                <div class="stat-line"><span>HP:</span><span id="player-hp">1380/1380</span></div>
                <div class="stat-line"><span>Ata:</span><span id="player-ata">600</span></div>
                <div class="stat-line"><span>Def:</span><span id="player-def">1380</span></div>
                <div class="stat-line"><span>Esp Atq:</span><span id="player-esp-atq">1632</span></div>
                <div class="stat-line"><span>Esp Def:</span><span id="player-esp-def">1380</span></div>
                <div class="stat-line"><span>Spd:</span><span id="player-spd">760</span></div>
            </div>
        </div>
        <div id="combat-log-wrapper">
            <p id="combat-log-text">Você usou Raio Mágico e causou 1089 de dano.<br>Você recuperou 207 de HP.<br><br>Você derrotou o Triângulo Bruto!</p>
            <button id="combat-advance-btn" style="display: block;">Avançar</button>
        </div>
        <div id="combat-menu" style="display: none;">
            <div class="combat-btn" id="combat-fisico">Ataque Físico</div>
            <div class="combat-btn" id="combat-magico">Ataque Mágico</div>
            <div class="combat-btn" id="combat-voltar">Voltar</div>
        </div>
    </div>

    <div id="menu-screen" class="ui-screen" style="display: none;">
        <h2>Menu</h2>
        <div class="menu-option" id="menu-profile">Perfil</div>
        <div class="menu-option" id="menu-equip">Equipamentos</div>
        <div class="menu-option" id="menu-status">Status</div>
        <div class="menu-option" id="menu-inventory">Inventário</div>
        <div class="menu-option" id="menu-save-load">Salvar/Carregar</div>
        <div class="menu-option" id="menu-update">Atualização</div>
        <div class="menu-option" id="menu-restart">Recomeçar</div>
        <div class="menu-option" id="menu-close">Fechar</div>
    </div>
    <div id="inventory-screen" class="ui-screen" style="display: none;">
        <h2>Inventário</h2>
        <div class="oficina-tabs">
            <div class="oficina-tab active" id="inv-tab-cura">Itens de Cura</div>
            <div class="oficina-tab" id="inv-tab-equip">Equipamentos</div>
        </div>
        <div id="inventory-content-cura" class="oficina-content active" style="display: block;"><div class="inventory-item">Poção de Cura Menor (x32) - Cura 50 HP</div></div>
        <div id="inventory-content-equip" class="oficina-content" style="display: none;"></div>
        <div class="menu-option" id="inventory-close">Voltar</div>
    </div>
    <div id="shop-screen" class="ui-screen" style="display: none;">
        <h2>Loja</h2><div id="shop-list"></div><div class="menu-option" id="shop-close">Sair da Loja</div>
    </div>
    <div id="status-screen" class="ui-screen" style="display: none;">
        <h2>Status</h2><div id="status-list"><div class="status-line"><span>Pontos para distribuir:</span> <span id="status-pontos">516</span></div><div class="status-line" id="status-line-vidaMax"><span>Vida Máxima:</span> <span id="status-val-vidaMax">1000</span><div id="status-btns-vidaMax"><button class="status-downgrade-btn">-</button><button class="status-upgrade-btn">+</button></div></div><div class="status-line" id="status-line-vidaAtual"><span>Vida Atual:</span> <span id="status-val-vidaAtual">1380</span><div id="status-btns-vidaAtual"></div></div><div class="status-line" id="status-line-velocidade"><span>Velocidade:</span> <span id="status-val-velocidade">600</span><div id="status-btns-velocidade"><button class="status-downgrade-btn">-</button><button class="status-upgrade-btn">+</button></div></div><div class="status-line" id="status-line-forcaFisica"><span>Força Física:</span> <span id="status-val-forcaFisica">600</span><div id="status-btns-forcaFisica"><button class="status-downgrade-btn">-</button><button class="status-upgrade-btn">+</button></div></div><div class="status-line" id="status-line-inteligencia"><span>Inteligência:</span> <span id="status-val-inteligencia">1000</span><div id="status-btns-inteligencia"><button class="status-downgrade-btn">-</button><button class="status-upgrade-btn">+</button></div></div><div class="status-line" id="status-line-resistenciaFisica"><span>Resistência Física:</span> <span id="status-val-resistenciaFisica">1000</span><div id="status-btns-resistenciaFisica"><button class="status-downgrade-btn">-</button><button class="status-upgrade-btn">+</button></div></div><div class="status-line" id="status-line-resistenciaMagica"><span>Resistência Mágica:</span> <span id="status-val-resistenciaMagica">1000</span><div id="status-btns-resistenciaMagica"><button class="status-downgrade-btn">-</button><button class="status-upgrade-btn">+</button></div></div><div class="menu-option" id="status-close">Voltar</div></div>
    </div>
    <div id="rank-screen" class="ui-screen" style="display: none;">
        <h2>Cristal de Despertar</h2>
        <div id="rank-info"><p>Rank Atual: 5</p><p>Prestígio: 30</p><p>Nível: 206</p><p>Pontos: 516</p></div>
        <div id="rank-options-list"><div class="rank-option">Reavaliar Rank (Custo: 10 Pontos, 2 Níveis)</div><div class="rank-option">Prestigiar (Próximo: 31) - Req. Nível 100, Custo: 500 Pontos</div></div>
        <div class="menu-option" id="rank-close">Sair</div>
    </div>
    <div id="profile-screen" class="ui-screen" style="display: none;">
        <h2>Perfil</h2>
        <div id="profile-info">
            <div class="status-line"><span>Nível:</span> <span>150</span></div>
            <div class="status-line"><span>Rank:</span> <span>5</span></div>
            <div class="status-line"><span>Prestígio:</span> <span>0</span></div>
            <div class="status-line"><span>Andar Mais Alto:</span> <span>155</span></div>
            <div class="status-line"><span>XP Total Adquirido:</span> <span>1136731</span></div>
            <div class="status-line"><span>Pontos de Atributo:</span> <span>24</span></div>
            <div class="status-line"><span>Gemas:</span> <span>11055</span></div>
        </div>
        <div class="menu-option" id="profile-close">Voltar</div>
    </div>
    <div id="save-load-screen" class="ui-screen" style="display: flex;">
        <h2>Salvar / Carregar</h2>
        <div class="menu-option" id="save-full-html">Baixar Jogo Completo</div>
        <div class="menu-option" id="save-player-json">Baixar Apenas o Save (JSON)</div>
        <label for="json-upload" id="json-upload-label">Atualizar com JSON</label>
        <input type="file" id="json-upload" accept=".json">
        <label for="equip-json-upload" id="json-upload-label">Atualizar Equipamentos (JSON)</label>
        <input type="file" id="equip-json-upload" accept=".json">
        <div class="menu-option" id="save-load-close">Voltar</div>
    </div>
    <div id="equip-screen" class="ui-screen" style="display: none;">
        <h2>Equipamentos</h2>
        <div id="equip-slots-container"><h3>Equipado Atualmente</h3><div class="equip-slot filled"><strong>Cajado de Mithril (Nvl. 15)</strong> - Arma<br><small>Inteligência: +29.0%<br></small></div><div class="equip-slot filled"><strong>Armadura de Mithril (Nvl. 15)</strong> - Armadura<br><small>Vida Máxima: +38.0%<br></small></div><div class="equip-slot filled"><strong>Manto de Mithril (Nvl. 15)</strong> - Manto<br><small>Resistência Mágica: +38.0%<br></small></div><div class="equip-slot filled"><strong>Botas de Mithril (Nvl. 15)</strong> - Bota<br><small>Velocidade: +19.0%<br></small></div><div class="equip-slot filled"><strong>Anel Mágico de Mithril (Nvl. 15)</strong> - Anel<br><small>Inteligência: +19.0%<br></small></div><div class="equip-slot filled"><strong>Luvas de Mithril (Nvl. 15)</strong> - Luva<br><small>Inteligência: +15.2%<br>Velocidade: +7.6%<br></small></div><div class="equip-slot filled"><strong>Escudo de Mithril (Nvl. 15)</strong> - Escudo<br><small>Resistência Física: +38.0%<br></small></div><div class="equip-slot filled"><strong>Cordão Vampírico de Mithril (Nvl. 15)</strong> - Cordão<br><small>Roubo de Vida: +19.0%<br></small></div></div>
        <div class="menu-option" id="equip-close">Voltar</div>
    </div>
    <div id="forja-screen" class="ui-screen" style="display: none;">
        <h2>Forja</h2>
        <div id="forja-tabs" class="oficina-tabs"><div class="oficina-tab active" data-tipo="__sumario__">__sumario__</div><div class="oficina-tab" data-tipo="Anel">Anel</div><div class="oficina-tab" data-tipo="Luva">Luva</div><div class="oficina-tab" data-tipo="Cordão">Cordão</div><div class="oficina-tab" data-tipo="Arma">Arma</div><div class="oficina-tab" data-tipo="Escudo">Escudo</div><div class="oficina-tab" data-tipo="Armadura">Armadura</div><div class="oficina-tab" data-tipo="Manto">Manto</div><div class="oficina-tab" data-tipo="Bota">Bota</div><div class="oficina-tab" data-tipo="Vender">Vender</div></div>
        <div id="forja-content"><div class="status-line"><span>XP Total:</span> <span>529594</span></div><div class="status-line"><span>Gemas:</span> <span>18461</span></div><hr><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div><div class="craft-item">Forjar <strong>undefined</strong><br><small>Custo: undefined XP Total, undefined Gemas</small></div></div>
        <div class="menu-option" id="forja-close">Voltar</div>
    </div>
    <div id="forja-details-screen" class="ui-screen" style="display: none;">
        <h2>Detalhes da Forja</h2>
        <div id="forja-details-info"></div>
        <div id="forja-details-options"></div>
        <div class="menu-option" id="forja-details-close">Voltar</div>
    </div>
    <div id="item-details-screen" class="ui-screen" style="display: none;">
        <h2>Detalhes do Item</h2>
        <div id="item-details-info"><h3>Escudo de Mithril (Nvl. 15)</h3><p>Status: Resistência Física +38.0%</p><h4>Custo para Melhorar:</h4><p>XP: 27284 / 13768</p><p>Gemas: 21265 / 1382384</p><p>Pontos de Atributo: 1 / 516</p></div>
        <div id="item-details-options"><div class="menu-option">Desequipar</div><div class="menu-option disabled">Melhorar</div></div>
        <div class="menu-option" id="item-details-close">Voltar</div>
    </div>
    <div id="elevator-screen" class="ui-screen" style="display: none;">
        <h2>Elevador da Masmorra</h2>
        <div id="elevator-tabs"><div class="elevator-tab active" data-tab-index="5">Andares 401-500</div><div class="elevator-tab" data-tab-index="4">Andares 301-400</div><div class="elevator-tab" data-tab-index="3">Andares 201-300</div><div class="elevator-tab" data-tab-index="2">Andares 101-200</div><div class="elevator-tab" data-tab-index="1">Andares 1-100</div></div>
        <div id="elevator-floors"><div class="elevator-option">Ir para o Andar 480</div><div class="elevator-option">Ir para o Andar 475</div><div class="elevator-option">Ir para o Andar 470</div><div class="elevator-option">Ir para o Andar 465</div><div class="elevator-option">Ir para o Andar 460</div><div class="elevator-option">Ir para o Andar 455</div><div class="elevator-option">Ir para o Andar 450</div><div class="elevator-option">Ir para o Andar 445</div><div class="elevator-option">Ir para o Andar 440</div><div class="elevator-option">Ir para o Andar 435</div><div class="elevator-option">Ir para o Andar 430</div><div class="elevator-option">Ir para o Andar 425</div><div class="elevator-option">Ir para o Andar 420</div><div class="elevator-option">Ir para o Andar 415</div><div class="elevator-option">Ir para o Andar 410</div><div class="elevator-option">Ir para o Andar 405</div></div>
        <div class="menu-option" id="elevator-return-city">Voltar para a Cidade</div>
        <div class="menu-option" id="elevator-close">Cancelar</div>
    </div>
    <div id="tutor-screen" class="ui-screen" style="display: none;">
        <h2>Professor</h2>
        <div id="tutor-content">Olá, jovem aventureiro! Bem-vindo ao Legado Azul.<br>Seu objetivo é desbravar a masmorra, ficando cada vez mais forte.<br><br><strong>Dicas:</strong><ul><li>- Use seus pontos de atributo na tela de Status para aumentar seu poder.</li><li>- O Cristal de Despertar na cidade pode liberar seu potencial oculto (Rank).</li><li>- Fale com o Ferreiro (NPC Cinza) para criar equipamentos poderosos.</li><li>- Visite a Vendedora (NPC Verde) para comprar itens de cura.</li><li>- A masmorra fica mais difícil a cada andar. Não hesite em voltar e treinar!</li></ul></div>
        <div class="menu-option" id="tutor-close">Entendido!</div>
    </div>
    <div id="color-changer-screen" class="ui-screen" style="display: none;">
        <div id="color-changer-content"><h2>Mudar Aparência</h2><p>Olá! Gostaria de mudar sua cor? Custa 10000 Gemas.</p></div>
        <div class="stat-line"><span>Suas Gemas:</span> <span id="color-changer-gemas">100</span></div>
        <hr style="margin: 10px 0;">
        <div id="color-preview" style="background-color: rgb(52, 152, 219);"></div>
        <div class="stat-line">
            <label for="red-slider">Vermelho: <span id="red-value">52</span></label>
            <input type="range" id="red-slider" min="0" max="255" value="127">
        </div>
        <div class="stat-line">
            <label for="green-slider">Verde: <span id="green-value">152</span></label>
            <input type="range" id="green-slider" min="0" max="255" value="127">
        </div>
        <div class="stat-line">
            <label for="blue-slider">Azul: <span id="blue-value">219</span></label>
            <input type="range" id="blue-slider" min="0" max="255" value="127">
        </div>
        <div class="menu-option" id="color-confirm-btn">Confirmar Mudança</div>
        <div class="menu-option" id="color-cancel-btn">Cancelar</div>
    </div>
    <div id="update-screen" class="ui-screen" style="display: none;">
        <h2>Editor de Dados do Jogo</h2>
        <p>Modifique os JSONs abaixo para alterar o balanceamento e os dados do jogo. Clique em "Baixar" para salvar um novo HTML com suas mudanças.</p>
        
        <div class="menu-option" id="download-updated-html-btn">Baixar Jogo Atualizado</div>
        <div id="json-editors-wrapper"><div class="json-editor-container"><label for="editor-COMBAT_FORMULAS">COMBAT_FORMULAS</label><textarea id="editor-COMBAT_FORMULAS" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-DUNGEON_CONFIG">DUNGEON_CONFIG</label><textarea id="editor-DUNGEON_CONFIG" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-EQUIPMENT_DATA">EQUIPMENT_DATA</label><textarea id="editor-EQUIPMENT_DATA" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-ITEM_DATA">ITEM_DATA</label><textarea id="editor-ITEM_DATA" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-MAP_DATA">MAP_DATA</label><textarea id="editor-MAP_DATA" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-MONSTER_DATA">MONSTER_DATA</label><textarea id="editor-MONSTER_DATA" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-NPC_DATA">NPC_DATA</label><textarea id="editor-NPC_DATA" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-PLAYER_DEFAULTS">PLAYER_DEFAULTS</label><textarea id="editor-PLAYER_DEFAULTS" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-PROGRESSION_SYSTEM">PROGRESSION_SYSTEM</label><textarea id="editor-PROGRESSION_SYSTEM" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-SHOP_DATA">SHOP_DATA</label><textarea id="editor-SHOP_DATA" class="json-editor-textarea"></textarea></div><div class="json-editor-container"><label for="editor-SKILL_DATA">SKILL_DATA</label><textarea id="editor-SKILL_DATA" class="json-editor-textarea"></textarea></div></div>
        <div class="menu-option" id="update-close">Voltar</div>
    </div>

    <!-- ================================================================= -->
    <!-- DADOS DO JOGO EM JSON (EDITÁVEIS) -->
    <!-- ================================================================= -->
    <div id="game-data-definitions" style="display:none;">

        <textarea id="data-PLAYER_DEFAULTS">{"__sumario__":"Configurações iniciais e padrão do jogador. Todos os valores aqui são usados para criar um novo personagem ou para resetar o progresso.","x":2,"_comment_x":"1. Posição inicial do jogador no eixo X no mapa 'CASA'.","y":2,"_comment_y":"2. Posição inicial do jogador no eixo Y no mapa 'CASA'.","nivel":1,"_comment_nivel":"3. Nível inicial do jogador.","xp":0,"_comment_xp":"4. Experiência atual do jogador.","xpParaNivel":100,"_comment_xpParaNivel":"5. Experiência necessária para o próximo nível (este valor será recalculado pela fórmula em PROGRESSION_SYSTEM).","gemas":100,"_comment_gemas":"6. Moeda do jogo inicial.","playerColor":"#3498db","_comment_playerColor":"7. Cor hexadecimal do personagem do jogador.","pontosDeAtributo":5,"_comment_pontosDeAtributo":"8. Pontos disponíveis para distribuir nos atributos.","rank":0,"_comment_rank":"9. Rank de potencial do jogador (0 = não despertado).","prestigio":0,"_comment_prestigio":"10. Nível de prestígio, que reseta o progresso para bônus maiores.","totalXpGanho":0,"_comment_totalXpGanho":"11. Acumulador de toda a experiência já ganha. Usado para custos de forja.","andarMaisAlto":0,"_comment_andarMaisAlto":"12. O andar mais alto que o jogador já alcançou na masmorra.","equipamentos":{"__sumario__":"Slots de equipamento do jogador. 'null' significa que o slot está vazio.","Arma":null,"Armadura":null,"Manto":null,"Bota":null,"Anel":null,"Luva":null,"Escudo":null,"Cordão":null},"inventarioEquipamentos":[],"_comment_inventarioEquipamentos":"13. Lista de todos os equipamentos que o jogador possui, equipados ou não.","atributos":{"__sumario__":"Atributos base do jogador. Estes são os valores sem a influência de equipamentos.","vidaMax":50,"vidaAtual":50,"velocidade":5,"forcaFisica":5,"inteligencia":5,"resistenciaFisica":5,"resistenciaMagica":5,"rouboDeVidaPercentual":0},"inventario":[{"itemId":1,"quantidade":5,"_comment":"14. Item inicial: 5x Bandagem Simples."},{"itemId":5,"quantidade":2,"_comment":"15. Item inicial: 2x Erva do Campo."}]}</textarea>

        <textarea id="data-PROGRESSION_SYSTEM">{"__sumario__":"Controla todas as fórmulas e regras de progressão do jogador, como nível, rank e prestígio.","leveling":{"__sumario__":"Regras para subir de nível.","xpFormula":"(nivel) =&gt; { return nivel * 100; }","_comment_xpFormula":"1. Fórmula para calcular o XP necessário para o próximo nível. Recebe 'nivel' atual e retorna o XP necessário.","attributePointsPerLevel":5,"_comment_attributePointsPerLevel":"2. Quantidade de pontos de atributo ganhos por nível."},"rank":{"__sumario__":"Sistema de Rank (Despertar).","rerollCost":{"points":10,"_comment_points":"3. Custo em pontos de atributo para re-rolar o rank.","levels":2,"_comment_levels":"4. Custo em níveis para re-rolar o rank."},"probabilities":[{"rank":5,"chance":0.01,"_comment_rank5":"5. Chance de 1% de obter Rank 5."},{"rank":1,"chance":0.08,"_comment_rank1":"6. Chance de 8% de obter Rank 1."},{"rank":4,"chance":0.2,"_comment_rank4":"7. Chance de 20% de obter Rank 4."},{"rank":3,"chance":0.5,"_comment_rank3":"8. Chance de 50% de obter Rank 3."},{"rank":2,"chance":1,"_comment_rank2":"9. Chance de 100% (fallback) de obter Rank 2."}]},"prestige":{"__sumario__":"Sistema de Prestígio.","requirements":[{"prestigeLevel":1,"requiredPlayerLevel":50,"_comment_prestige1":"10. Para atingir o Prestígio 1, o jogador deve estar no nível 50."},{"prestigeLevel":2,"requiredPlayerLevel":60,"_comment_prestige2":"11. Para o Prestígio 2, nível 60."},{"prestigeLevel":3,"requiredPlayerLevel":70,"_comment_prestige3":"12. Para o Prestígio 3, nível 70."},{"prestigeLevel":4,"requiredPlayerLevel":100,"_comment_prestige4":"13. Para os demais, nível 100."}],"costFormula":"(requiredLevel) =&gt; { return requiredLevel * 5; }","_comment_costFormula":"14. Fórmula para calcular o custo em pontos de atributo para prestigiar.","xpMultiplierBonus":0.5,"_comment_xpMultiplierBonus":"15. Bônus de multiplicador de XP ganho por cada nível de prestígio."},"xpMultiplierFormula":"(player) =&gt; { let mult = 1.0; if (player.rank &gt; 1) { mult = parseFloat(player.rank); } else if (player.rank === 1) { mult = 1.0; } mult += player.prestigio * GAME_DATA.PROGRESSION_SYSTEM.prestige.xpMultiplierBonus; return mult; }","_comment_xpMultiplierFormula":"16. Fórmula completa para calcular o multiplicador de XP. Leva em conta Rank e Prestígio."}</textarea>

        <textarea id="data-COMBAT_FORMULAS">{"__sumario__":"Centraliza todas as fórmulas de combate do jogo.","damageCalculation":{"fisico":"(atacanteStats, defensorStats) =&gt; { return Math.max(1, Math.round(atacanteStats.forcaFisica - defensorStats.resistenciaFisica)); }","_comment_fisico":"1. Fórmula de dano FÍSICO. Recebe os status totais do atacante e do defensor.","magico":"(atacanteStats, defensorStats) =&gt; { return Math.max(1, Math.round(atacanteStats.inteligencia - defensorStats.resistenciaMagica)); }","_comment_magico":"2. Fórmula de dano MÁGICO."},"lifestealCalculation":"(damageDealt, attackerStats) =&gt; { return Math.ceil(damageDealt * attackerStats.rouboDeVidaPercentual); }","_comment_lifesteal":"3. Fórmula para calcular a cura por Roubo de Vida.","xpGainFormula":"(enemy, xpMultiplier) =&gt; { return Math.floor((enemy.pontosTotais / 5) * xpMultiplier); }","_comment_xpGain":"4. Fórmula para calcular o XP ganho ao derrotar um inimigo.","gemGainFormula":"(enemy) =&gt; { return enemy.nivel; }","_comment_gemGain":"5. Fórmula para calcular as Gemas ganhas ao derrotar um inimigo."}</textarea>

        <textarea id="data-MAP_DATA">{"__sumario__":"Define a estrutura de todos os mapas do jogo, incluindo paredes, chão e portais.","CASA":{"grid":[[1,1,1,1,1],[1,0,0,9,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,2,1,1]],"portais":{"2":{"para":"CIDADE","x":9,"y":17}}},"CIDADE":{"grid":[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1],[1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,21,0,0,0,1],[1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,20,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,23,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],"portais":{"2":{"para":"CASA","x":2,"y":3}}}}</textarea>

        <textarea id="data-DUNGEON_CONFIG">{"__sumario__":"Configurações para a geração procedural da masmorra.","width":15,"_comment_width":"1. Largura do mapa da masmorra.","height":15,"_comment_height":"2. Altura do mapa da masmorra.","minMonsters":10,"_comment_minMonsters":"3. Número mínimo de monstros por andar.","maxMonsters":40,"_comment_maxMonsters":"4. Número máximo de monstros por andar.","monsterLevelVariance":3,"_comment_monsterLevelVariance":"5. Variação de nível dos monstros em relação ao nível do andar (ex: andar 10, monstros podem ser do nível 10 a 13)."}</textarea>

        <textarea id="data-MONSTER_DATA">{"__sumario__":"Define os tipos de monstros, seus atributos e como eles são gerados.","types":[{"nome":"Mágico","cor":"#9b59b6","ataque":"magico","specStats":["inteligencia","resistenciaMagica"],"_comment":"1. Monstro focado em ataque e defesa mágicos."},{"nome":"Encantado","cor":"#f1c40f","ataque":"magico","specStats":["resistenciaFisica","inteligencia"],"_comment":"2. Monstro tanque mágico."},{"nome":"Físico","cor":"#c0392b","ataque":"fisico","specStats":["forcaFisica","resistenciaFisica"],"_comment":"3. Monstro focado em ataque e defesa físicos."},{"nome":"Bruto","cor":"#C8A2C8","ataque":"fisico","specStats":["forcaFisica","resistenciaMagica"],"_comment":"4. Monstro 'berserker', alto dano físico e defesa mágica."}],"statGeneration":{"basePointsFormula":"(nivel) =&gt; 50 + 5 * (nivel - 1)","_comment_basePoints":"5. Fórmula para os pontos de atributo base de um monstro, baseado no nível.","randomVariance":26,"_comment_randomVariance":"6. Valor máximo de variação aleatória somado aos pontos base.","distribution":{"vidaMax":0.4,"_comment_vidaMax":"7. 40% dos pontos totais vão para Vida Máxima.","velocidade":0.1,"_comment_velocidade":"8. 10% dos pontos totais vão para Velocidade.","minPerNonSpecStat":0.03,"_comment_minPerNonSpecStat":"9. Porcentagem mínima (3%) dos pontos totais para cada atributo não especializado."}}}</textarea>

        <textarea id="data-NPC_DATA">{"__sumario__":"Define os NPCs, seus IDs no mapa e suas funções.","npcs":[{"tileId":20,"nome":"Estilista","cor":"var(--npc-purple-color)","action":"abrirColorChanger","_comment":"1. NPC que permite mudar a cor do jogador."},{"tileId":21,"nome":"Vendedora","cor":"var(--npc-green-color)","action":"abrirLoja","_comment":"2. NPC que abre a loja de itens."},{"tileId":22,"nome":"Ferreiro","cor":"var(--npc-gray-color)","action":"abrirForja","_comment":"3. NPC que abre a forja."},{"tileId":23,"nome":"Professor","cor":"var(--npc-pink-color)","action":"abrirTutor","_comment":"4. NPC que dá dicas e tutorial."}],"dialogues":{"tutor":{"titulo":"Professor","texto":"Olá, jovem aventureiro! Bem-vindo ao Legado Azul.&lt;br&gt;Seu objetivo é desbravar a masmorra, ficando cada vez mais forte.&lt;br&gt;&lt;br&gt;&lt;strong&gt;Dicas:&lt;/strong&gt;&lt;ul&gt;&lt;li&gt;- Use seus pontos de atributo na tela de Status para aumentar seu poder.&lt;/li&gt;&lt;li&gt;- O Cristal de Despertar na cidade pode liberar seu potencial oculto (Rank).&lt;/li&gt;&lt;li&gt;- Fale com o Ferreiro (NPC Cinza) para criar equipamentos poderosos.&lt;/li&gt;&lt;li&gt;- Visite a Vendedora (NPC Verde) para comprar itens de cura.&lt;/li&gt;&lt;li&gt;- A masmorra fica mais difícil a cada andar. Não hesite em voltar e treinar!&lt;/li&gt;&lt;/ul&gt;"},"colorChanger":{"titulo":"Mudar Aparência","texto":"Olá! Gostaria de mudar sua cor? Custa 10000 Gemas."}}}</textarea>

        <textarea id="data-ITEM_DATA">{"1":{"nome":"Bandagem Simples","descricao":"Cura 20 HP","efeito":"(p) =&gt; { p.atributos.vidaAtual = Math.min(calcularStatusTotais(p).vidaMax, p.atributos.vidaAtual + 20); return `Você usou ${GAME_DATA.ITEM_DATA[1].nome} e recuperou 20 de HP.`; }"},"2":{"nome":"Poção de Cura Menor","descricao":"Cura 50 HP","efeito":"(p) =&gt; { p.atributos.vidaAtual = Math.min(calcularStatusTotais(p).vidaMax, p.atributos.vidaAtual + 50); return `Você usou ${GAME_DATA.ITEM_DATA[2].nome} e recuperou 50 de HP.`; }"},"3":{"nome":"Poção de Cura Maior","descricao":"Cura 120 HP","efeito":"(p) =&gt; { p.atributos.vidaAtual = Math.min(calcularStatusTotais(p).vidaMax, p.atributos.vidaAtual + 120); return `Você usou ${GAME_DATA.ITEM_DATA[3].nome} e recuperou 120 de HP.`; }"},"4":{"nome":"Super Poção","descricao":"Cura 30% do HP Máximo","efeito":"(p) =&gt; { const cura = calcularStatusTotais(p).vidaMax * 0.30; p.atributos.vidaAtual = Math.min(calcularStatusTotais(p).vidaMax, p.atributos.vidaAtual + cura); return `Você usou ${GAME_DATA.ITEM_DATA[4].nome} e recuperou ${Math.round(cura)} de HP.`; }"},"5":{"nome":"Erva do Campo","descricao":"Cura 4% do HP Máximo","efeito":"(p) =&gt; { const cura = calcularStatusTotais(p).vidaMax * 0.04; p.atributos.vidaAtual = Math.min(calcularStatusTotais(p).vidaMax, p.atributos.vidaAtual + cura); return `Você usou ${GAME_DATA.ITEM_DATA[5].nome} e recuperou ${Math.round(cura)} de HP.`; }"},"6":{"nome":"Elixir","descricao":"Cura todo o HP","efeito":"(p) =&gt; { p.atributos.vidaAtual = calcularStatusTotais(p).vidaMax; return `Você usou ${GAME_DATA.ITEM_DATA[6].nome} e recuperou todo o HP!`; }"},"__sumario__":"Banco de dados de todos os itens consumíveis do jogo."}</textarea>

        <textarea id="data-SHOP_DATA">{"__sumario__":"Lista de itens vendidos na loja e seus preços.","items":[{"itemId":1,"preco":10},{"itemId":2,"preco":25},{"itemId":3,"preco":80},{"itemId":4,"preco":150},{"itemId":5,"preco":50},{"itemId":6,"preco":500}]}</textarea>

        <textarea id="data-EQUIPMENT_DATA">{"__sumario__":"Banco de dados de todos os equipamentos base do jogo.","Anel":{"anel_ferro":{"nome":"Anel Mágico de Ferro","tipo":"Anel","habilidadesBase":[{"stat":"inteligencia","valor":5,"tipo":"fixo"}],"levelUpScaling":[1],"custoXp":1200,"custoGemas":2000,"custoMelhoriaXpInicial":100,"custoMelhoriaGemasInicial":500},"anel_bronze":{"nome":"Anel Mágico de Bronze","tipo":"Anel","habilidadesBase":[{"stat":"inteligencia","valor":8,"tipo":"fixo"}],"levelUpScaling":[2],"custoXp":2400,"custoGemas":4000,"custoMelhoriaXpInicial":200,"custoMelhoriaGemasInicial":1000},"anel_ouro":{"nome":"Anel Mágico de Ouro","tipo":"Anel","habilidadesBase":[{"stat":"inteligencia","valor":12,"tipo":"fixo"}],"levelUpScaling":[3],"custoXp":4800,"custoGemas":8000,"custoMelhoriaXpInicial":400,"custoMelhoriaGemasInicial":2000},"anel_mithril":{"nome":"Anel Mágico de Mithril","tipo":"Anel","habilidadesBase":[{"stat":"inteligencia","valor":0.05,"tipo":"percentual"}],"levelUpScaling":[0.01],"custoXp":9600,"custoGemas":16000,"custoMelhoriaXpInicial":800,"custoMelhoriaGemasInicial":4000}},"Luva":{"luva_couro":{"nome":"Luvas de Couro","tipo":"Luva","habilidadesBase":[{"stat":"inteligencia","valor":3,"tipo":"fixo"},{"stat":"velocidade","valor":2,"tipo":"fixo"}],"levelUpScaling":[0.8,0.5],"custoXp":1100,"custoGemas":1600,"custoMelhoriaXpInicial":90,"custoMelhoriaGemasInicial":450},"luva_bronze":{"nome":"Luvas de Bronze","tipo":"Luva","habilidadesBase":[{"stat":"inteligencia","valor":6,"tipo":"fixo"},{"stat":"velocidade","valor":4,"tipo":"fixo"}],"levelUpScaling":[1.5,0.8],"custoXp":2200,"custoGemas":3200,"custoMelhoriaXpInicial":180,"custoMelhoriaGemasInicial":900},"luva_ouro":{"nome":"Luvas de Ouro","tipo":"Luva","habilidadesBase":[{"stat":"inteligencia","valor":10,"tipo":"fixo"},{"stat":"velocidade","valor":6,"tipo":"fixo"}],"levelUpScaling":[2.5,1.2],"custoXp":4400,"custoGemas":6400,"custoMelhoriaXpInicial":360,"custoMelhoriaGemasInicial":1800},"luva_mithril":{"nome":"Luvas de Mithril","tipo":"Luva","habilidadesBase":[{"stat":"inteligencia","valor":0.04,"tipo":"percentual"},{"stat":"velocidade","valor":0.02,"tipo":"percentual"}],"levelUpScaling":[0.008,0.004],"custoXp":8800,"custoGemas":12800,"custoMelhoriaXpInicial":720,"custoMelhoriaGemasInicial":3600}},"Cordão":{"cordao_ferro":{"nome":"Cordão Vampírico de Ferro","tipo":"Cordão","habilidadesBase":[{"stat":"rouboDeVidaPercentual","valor":0.01,"tipo":"fixo"}],"levelUpScaling":[0.002],"custoXp":1600,"custoGemas":4000,"custoMelhoriaXpInicial":100,"custoMelhoriaGemasInicial":500},"cordao_bronze":{"nome":"Cordão Vampírico de Bronze","tipo":"Cordão","habilidadesBase":[{"stat":"rouboDeVidaPercentual","valor":0.02,"tipo":"fixo"}],"levelUpScaling":[0.004],"custoXp":3200,"custoGemas":8000,"custoMelhoriaXpInicial":200,"custoMelhoriaGemasInicial":1000},"cordao_ouro":{"nome":"Cordão Vampírico de Ouro","tipo":"Cordão","habilidadesBase":[{"stat":"rouboDeVidaPercentual","valor":0.03,"tipo":"fixo"}],"levelUpScaling":[0.006],"custoXp":6400,"custoGemas":16000,"custoMelhoriaXpInicial":400,"custoMelhoriaGemasInicial":2000},"cordao_mithril":{"nome":"Cordão Vampírico de Mithril","tipo":"Cordão","habilidadesBase":[{"stat":"rouboDeVidaPercentual","valor":0.05,"tipo":"fixo"}],"levelUpScaling":[0.01],"custoXp":12800,"custoGemas":32000,"custoMelhoriaXpInicial":800,"custoMelhoriaGemasInicial":4000}},"Arma":{"adaga_ferro":{"nome":"Adaga de Ferro","tipo":"Arma","habilidadesBase":[{"stat":"forcaFisica","valor":4,"tipo":"fixo"},{"stat":"velocidade","valor":2,"tipo":"fixo"}],"levelUpScaling":[1,0.5],"custoXp":1000,"custoGemas":1500,"custoMelhoriaXpInicial":80,"custoMelhoriaGemasInicial":400},"adaga_bronze":{"nome":"Adaga de Bronze","tipo":"Arma","habilidadesBase":[{"stat":"forcaFisica","valor":7,"tipo":"fixo"},{"stat":"velocidade","valor":4,"tipo":"fixo"}],"levelUpScaling":[1.5,0.8],"custoXp":2000,"custoGemas":3000,"custoMelhoriaXpInicial":160,"custoMelhoriaGemasInicial":800},"adaga_ouro":{"nome":"Adaga de Ouro","tipo":"Arma","habilidadesBase":[{"stat":"forcaFisica","valor":11,"tipo":"fixo"},{"stat":"velocidade","valor":6,"tipo":"fixo"}],"levelUpScaling":[2,1],"custoXp":4000,"custoGemas":6000,"custoMelhoriaXpInicial":320,"custoMelhoriaGemasInicial":1600},"adaga_mithril":{"nome":"Adaga de Mithril","tipo":"Arma","habilidadesBase":[{"stat":"forcaFisica","valor":0.04,"tipo":"percentual"},{"stat":"velocidade","valor":0.02,"tipo":"percentual"}],"levelUpScaling":[0.008,0.004],"custoXp":8000,"custoGemas":12000,"custoMelhoriaXpInicial":640,"custoMelhoriaGemasInicial":3200},"espada_ferro":{"nome":"Espada de Ferro","tipo":"Arma","habilidadesBase":[{"stat":"forcaFisica","valor":8,"tipo":"fixo"}],"levelUpScaling":[1.5],"custoXp":1500,"custoGemas":2200,"custoMelhoriaXpInicial":120,"custoMelhoriaGemasInicial":600},"espada_bronze":{"nome":"Espada de Bronze","tipo":"Arma","habilidadesBase":[{"stat":"forcaFisica","valor":13,"tipo":"fixo"}],"levelUpScaling":[2.5],"custoXp":3000,"custoGemas":4400,"custoMelhoriaXpInicial":240,"custoMelhoriaGemasInicial":1200},"espada_ouro":{"nome":"Espada de Ouro","tipo":"Arma","habilidadesBase":[{"stat":"forcaFisica","valor":20,"tipo":"fixo"}],"levelUpScaling":[4],"custoXp":6000,"custoGemas":8800,"custoMelhoriaXpInicial":480,"custoMelhoriaGemasInicial":2400},"espada_mithril":{"nome":"Espada de Mithril","tipo":"Arma","habilidadesBase":[{"stat":"forcaFisica","valor":0.08,"tipo":"percentual"}],"levelUpScaling":[0.015],"custoXp":12000,"custoGemas":17600,"custoMelhoriaXpInicial":960,"custoMelhoriaGemasInicial":4800},"cajado_aprendiz":{"nome":"Cajado de Aprendiz","tipo":"Arma","habilidadesBase":[{"stat":"inteligencia","valor":8,"tipo":"fixo"}],"levelUpScaling":[1.5],"custoXp":1500,"custoGemas":2200,"custoMelhoriaXpInicial":120,"custoMelhoriaGemasInicial":600},"cajado_mago":{"nome":"Cajado de Mago","tipo":"Arma","habilidadesBase":[{"stat":"inteligencia","valor":13,"tipo":"fixo"}],"levelUpScaling":[2.5],"custoXp":3000,"custoGemas":4400,"custoMelhoriaXpInicial":240,"custoMelhoriaGemasInicial":1200},"cajado_arquimago":{"nome":"Cajado de Arquimago","tipo":"Arma","habilidadesBase":[{"stat":"inteligencia","valor":20,"tipo":"fixo"}],"levelUpScaling":[4],"custoXp":6000,"custoGemas":8800,"custoMelhoriaXpInicial":480,"custoMelhoriaGemasInicial":2400},"cajado_mithril":{"nome":"Cajado de Mithril","tipo":"Arma","habilidadesBase":[{"stat":"inteligencia","valor":0.08,"tipo":"percentual"}],"levelUpScaling":[0.015],"custoXp":12000,"custoGemas":17600,"custoMelhoriaXpInicial":960,"custoMelhoriaGemasInicial":4800}},"Escudo":{"escudo_madeira":{"nome":"Escudo de Madeira","tipo":"Escudo","habilidadesBase":[{"stat":"resistenciaFisica","valor":10,"tipo":"fixo"}],"levelUpScaling":[2],"custoXp":1800,"custoGemas":2500,"custoMelhoriaXpInicial":150,"custoMelhoriaGemasInicial":700},"escudo_bronze":{"nome":"Escudo de Bronze","tipo":"Escudo","habilidadesBase":[{"stat":"resistenciaFisica","valor":16,"tipo":"fixo"}],"levelUpScaling":[3],"custoXp":3600,"custoGemas":5000,"custoMelhoriaXpInicial":300,"custoMelhoriaGemasInicial":1400},"escudo_ouro":{"nome":"Escudo de Ouro","tipo":"Escudo","habilidadesBase":[{"stat":"resistenciaFisica","valor":25,"tipo":"fixo"}],"levelUpScaling":[5],"custoXp":7200,"custoGemas":10000,"custoMelhoriaXpInicial":600,"custoMelhoriaGemasInicial":2800},"escudo_mithril":{"nome":"Escudo de Mithril","tipo":"Escudo","habilidadesBase":[{"stat":"resistenciaFisica","valor":0.1,"tipo":"percentual"}],"levelUpScaling":[0.02],"custoXp":14400,"custoGemas":20000,"custoMelhoriaXpInicial":1200,"custoMelhoriaGemasInicial":5600}},"Armadura":{"armadura_couro":{"nome":"Armadura de Couro","tipo":"Armadura","habilidadesBase":[{"stat":"vidaMax","valor":15,"tipo":"fixo"}],"levelUpScaling":[3],"custoXp":2000,"custoGemas":3000,"custoMelhoriaXpInicial":180,"custoMelhoriaGemasInicial":800},"armadura_bronze":{"nome":"Armadura de Bronze","tipo":"Armadura","habilidadesBase":[{"stat":"vidaMax","valor":25,"tipo":"fixo"}],"levelUpScaling":[5],"custoXp":4000,"custoGemas":6000,"custoMelhoriaXpInicial":360,"custoMelhoriaGemasInicial":1600},"armadura_ouro":{"nome":"Armadura de Ouro","tipo":"Armadura","habilidadesBase":[{"stat":"vidaMax","valor":40,"tipo":"fixo"}],"levelUpScaling":[8],"custoXp":8000,"custoGemas":12000,"custoMelhoriaXpInicial":720,"custoMelhoriaGemasInicial":3200},"armadura_mithril":{"nome":"Armadura de Mithril","tipo":"Armadura","habilidadesBase":[{"stat":"vidaMax","valor":0.1,"tipo":"percentual"}],"levelUpScaling":[0.02],"custoXp":16000,"custoGemas":24000,"custoMelhoriaXpInicial":1440,"custoMelhoriaGemasInicial":6400}},"Manto":{"manto_simples":{"nome":"Manto Simples","tipo":"Manto","habilidadesBase":[{"stat":"resistenciaMagica","valor":10,"tipo":"fixo"}],"levelUpScaling":[2],"custoXp":1800,"custoGemas":2500,"custoMelhoriaXpInicial":150,"custoMelhoriaGemasInicial":700},"manto_seda":{"nome":"Manto de Seda","tipo":"Manto","habilidadesBase":[{"stat":"resistenciaMagica","valor":16,"tipo":"fixo"}],"levelUpScaling":[3],"custoXp":3600,"custoGemas":5000,"custoMelhoriaXpInicial":300,"custoMelhoriaGemasInicial":1400},"manto_runico":{"nome":"Manto Rúnico","tipo":"Manto","habilidadesBase":[{"stat":"resistenciaMagica","valor":25,"tipo":"fixo"}],"levelUpScaling":[5],"custoXp":7200,"custoGemas":10000,"custoMelhoriaXpInicial":600,"custoMelhoriaGemasInicial":2800},"manto_mithril":{"nome":"Manto de Mithril","tipo":"Manto","habilidadesBase":[{"stat":"resistenciaMagica","valor":0.1,"tipo":"percentual"}],"levelUpScaling":[0.02],"custoXp":14400,"custoGemas":20000,"custoMelhoriaXpInicial":1200,"custoMelhoriaGemasInicial":5600}},"Bota":{"bota_couro":{"nome":"Botas de Couro","tipo":"Bota","habilidadesBase":[{"stat":"velocidade","valor":5,"tipo":"fixo"}],"levelUpScaling":[1],"custoXp":2200,"custoGemas":3200,"custoMelhoriaXpInicial":200,"custoMelhoriaGemasInicial":900},"bota_bronze":{"nome":"Botas de Bronze","tipo":"Bota","habilidadesBase":[{"stat":"velocidade","valor":8,"tipo":"fixo"}],"levelUpScaling":[1.5],"custoXp":4400,"custoGemas":6400,"custoMelhoriaXpInicial":400,"custoMelhoriaGemasInicial":1800},"bota_ouro":{"nome":"Botas de Ouro","tipo":"Bota","habilidadesBase":[{"stat":"velocidade","valor":13,"tipo":"fixo"}],"levelUpScaling":[2.5],"custoXp":8800,"custoGemas":12800,"custoMelhoriaXpInicial":800,"custoMelhoriaGemasInicial":3600},"bota_mithril":{"nome":"Botas de Mithril","tipo":"Bota","habilidadesBase":[{"stat":"velocidade","valor":0.05,"tipo":"percentual"}],"levelUpScaling":[0.01],"custoXp":17600,"custoGemas":25600,"custoMelhoriaXpInicial":1600,"custoMelhoriaGemasInicial":7200}}}</textarea>

        <textarea id="data-SKILL_DATA">{"__sumario__":"Define as habilidades de combate. A lógica de cada habilidade é definida aqui como uma função em formato de texto.","fisico":[{"id":101,"nome":"Golpe Direto","acao":"(atacante, defensor) =&gt; { const atacanteStats = (atacante.totalXpGanho !== undefined) ? calcularStatusTotais(atacante) : atacante.atributos; const defensorStats = (defensor.totalXpGanho !== undefined) ? calcularStatusTotais(defensor) : defensor.atributos; const danoCausado = GAME_DATA.COMBAT_FORMULAS.damageCalculation.fisico(atacanteStats, defensorStats); defensor.atributos.vidaAtual -= danoCausado; let msg = `${atacante.nome || 'Você'} usou ${GAME_DATA.SKILL_DATA.fisico[0].nome} e causou ${danoCausado} de dano.`; if (atacanteStats.rouboDeVidaPercentual &gt; 0) { const vidaRoubada = GAME_DATA.COMBAT_FORMULAS.lifestealCalculation(danoCausado, atacanteStats); if (vidaRoubada &gt; 0) { atacante.atributos.vidaAtual = Math.min(calcularStatusTotais(atacante).vidaMax, atacante.atributos.vidaAtual + vidaRoubada); msg += `\\n${atacante.nome || 'Você'} recuperou ${vidaRoubada} de HP.`; } } return msg; }"}],"magico":[{"id":201,"nome":"Raio Mágico","acao":"(atacante, defensor) =&gt; { const atacanteStats = (atacante.totalXpGanho !== undefined) ? calcularStatusTotais(atacante) : atacante.atributos; const defensorStats = (defensor.totalXpGanho !== undefined) ? calcularStatusTotais(defensor) : defensor.atributos; const danoCausado = GAME_DATA.COMBAT_FORMULAS.damageCalculation.magico(atacanteStats, defensorStats); defensor.atributos.vidaAtual -= danoCausado; let msg = `${atacante.nome || 'Você'} usou ${GAME_DATA.SKILL_DATA.magico[0].nome} e causou ${danoCausado} de dano.`; if (atacanteStats.rouboDeVidaPercentual &gt; 0) { const vidaRoubada = GAME_DATA.COMBAT_FORMULAS.lifestealCalculation(danoCausado, atacanteStats); if (vidaRoubada &gt; 0) { atacante.atributos.vidaAtual = Math.min(calcularStatusTotais(atacante).vidaMax, atacante.atributos.vidaAtual + vidaRoubada); msg += `\\n${atacante.nome || 'Você'} recuperou ${vidaRoubada} de HP.`; } } return msg; }"}]}</textarea>

    </div>


    <script>
    // Injeta os dados do save fornecido pelo usuário
    window.SAVED_GAME_DATA = null;
    
    // =================================================================
    // NÚCLEO DO JOGO E ESTADO
    // =================================================================
    let gameStateStack = ['PRE-JOGO'];
    const TILE_SIZE = 40;
    
    // Objeto global para armazenar todos os dados carregados do editor
    const GAME_DATA = {};

    let player; // Será inicializado a partir de GAME_DATA
    let masmorraAtual = { nivel: 0, monstros: [], mapa: null };
    let currentEnemy = null;
    
    // Variáveis de estado para confirmação
    let fleeConfirmStep = 0;
    let resetConfirmStep = 0;
    
    // =================================================================
    // CARREGAMENTO DE DADOS DO EDITOR
    // =================================================================
    /**
     * Carrega todos os dados dos <textarea> para o objeto global GAME_DATA.
     * Realiza o parse de JSON e de funções.
     */
    function loadGameDataFromEditor() {
        const dataDiv = document.getElementById('game-data-definitions');
        const textareas = dataDiv.getElementsByTagName('textarea');
        const editorsWrapper = document.getElementById('json-editors-wrapper');
        editorsWrapper.innerHTML = ''; // Limpa o wrapper antes de popular

        // Cria um array dos textareas para poder ordenar
        const sortedTextareas = Array.from(textareas).sort((a, b) => a.id.localeCompare(b.id));

        for (const textarea of sortedTextareas) {
            const key = textarea.id.replace('data-', '');
            const jsonString = textarea.value;

            // Adiciona o editor na tela de Atualização
            const container = document.createElement('div');
            container.className = 'json-editor-container';
            const label = document.createElement('label');
            label.setAttribute('for', `editor-${key}`);
            label.innerText = key;
            const editorTextarea = document.createElement('textarea');
            editorTextarea.id = `editor-${key}`;
            editorTextarea.className = 'json-editor-textarea';
            editorTextarea.value = JSON.stringify(JSON.parse(jsonString), null, 4); // Formata o JSON para leitura
            container.appendChild(label);
            container.appendChild(editorTextarea);
            editorsWrapper.appendChild(container);

            try {
                // Tenta fazer o parse do JSON
                let parsedData = JSON.parse(jsonString, (k, v) => {
                    // Reviver funções (para itens, habilidades, etc.)
                    if (typeof v === 'string' && (v.trim().startsWith('(') || v.trim().startsWith('async ('))) {
                        try {
                            // Usar o Construtor de Função para evitar problemas de escopo do eval
                            return new Function('return ' + v)();
                        } catch (e) {
                            console.error(`Erro ao avaliar a função para a chave "${k}":`, e);
                            return v; // Retorna a string original em caso de erro
                        }
                    }
                    return v;
                });
                GAME_DATA[key] = parsedData;
            } catch (e) {
                console.error(`Erro ao fazer parse do JSON para ${key}:`, e);
                logMessage(`ERRO CRÍTICO: Falha ao carregar dados de ${key}. Verifique o JSON.`);
            }
        }
        console.log("Dados do Jogo Carregados:", GAME_DATA);
    }

    // =================================================================
    // GERENCIADOR DE ESTADO (STATE MACHINE)
    // =================================================================
    function getCurrentState() { return gameStateStack[gameStateStack.length - 1]; }
    function pushState(newState) { gameStateStack.push(newState); onStateChange(); }
    function popState() { if (gameStateStack.length > 1) { gameStateStack.pop(); onStateChange(); } }
    function onStateChange() {
        document.querySelectorAll('.ui-screen').forEach(screen => screen.style.display = 'none');
        const currentState = getCurrentState();
        const screenMap = {
            'COMBATE': 'combat-screen', 'MENU': 'menu-screen', 'INVENTARIO': 'inventory-screen',
            'LOJA': 'shop-screen', 'STATUS': 'status-screen', 'RANK': 'rank-screen',
            'PERFIL': 'profile-screen', 'SAVE_LOAD': 'save-load-screen', 
            'EQUIPAMENTOS': 'equip-screen', 'FORJA': 'forja-screen', 'FORJA_DETALHES': 'forja-details-screen', 
            'ITEM_DETALHES': 'item-details-screen', 'ELEVADOR': 'elevator-screen', 
            'TUTOR': 'tutor-screen', 'COLOR_CHANGER': 'color-changer-screen',
            'UPDATE': 'update-screen'
        };
        const screenId = screenMap[currentState];
        if (screenId) document.getElementById(screenId).style.display = 'flex';
    }

    // =================================================================
    // LÓGICA DA MASMORRA
    // =================================================================
    function gerarMapaMasmorra(nivel) {
        const config = GAME_DATA.DUNGEON_CONFIG;
        const largura = config.width; 
        const altura = config.height;
        let grid = Array.from({ length: altura }, () => Array(largura).fill(0));
        let monstros = [];
        for (let y = 0; y < altura; y++) { for (let x = 0; x < largura; x++) { if (y === 0 || y === altura - 1 || x === 0 || x === largura - 1) { grid[y][x] = 1; } } }
        grid[1][largura - 2] = 7; 
        grid[altura - 2][largura - 2] = 8;
        grid[1][1] = 11;
        const numMonstros = Math.floor(Math.random() * (config.maxMonsters - config.minMonsters + 1)) + config.minMonsters;
        for (let i = 0; i < numMonstros; i++) {
            let monstroX, monstroY;
            do { monstroX = Math.floor(Math.random() * (largura - 2)) + 1; monstroY = Math.floor(Math.random() * (altura - 2)) + 1; } while (grid[monstroY][monstroX] !== 0);
            const monstroNivel = nivel + Math.floor(Math.random() * config.monsterLevelVariance);
            const monstro = gerarMonstro(monstroNivel);
            monstro.x = monstroX; monstro.y = monstroY; monstro.id = `m-${Date.now()}-${i}`;
            monstros.push(monstro);
        }
        return { grid, monstros };
    }

    function entrarNaMasmorra(nivel) {
        pushState('MASMORRA');
        player.andarMaisAlto = Math.max(player.andarMaisAlto, nivel);
        const dataMasmorra = gerarMapaMasmorra(nivel);
        masmorraAtual = { nivel: nivel, mapa: dataMasmorra.grid, monstros: dataMasmorra.monstros };
        player.x = 2; player.y = 2; 
        desenharCenario();
        desenharJogador();
        logMessage(`Você entrou no andar ${nivel} da masmorra.`);
    }

    // =================================================================
    // RENDERIZAÇÃO E LÓGICA DO MUNDO
    // =================================================================
    const viewport = document.getElementById('viewport');
    const gameContainer = document.getElementById('game-container');
    const playerElement = document.getElementById('player');
    const messageLog = document.getElementById('message-log');

    function desenharCenario(stateToDraw) {
        const currentState = stateToDraw || getCurrentState();
        gameContainer.innerHTML = ''; 
        gameContainer.appendChild(playerElement); 
        let mapa; 
        if (currentState === 'MASMORRA') { 
            mapa = masmorraAtual.mapa; 
            masmorraAtual.monstros.forEach(monstro => { 
                const monstroEl = document.createElement('div'); 
                monstroEl.className = 'monster-sprite'; 
                monstroEl.style.left = `${monstro.x * TILE_SIZE}px`; 
                monstroEl.style.top = `${monstro.y * TILE_SIZE}px`; 
                monstroEl.innerHTML = `<div class="monster-triangle"></div>`; 
                monstroEl.querySelector('.monster-triangle').style.borderBottomColor = monstro.cor;
                gameContainer.appendChild(monstroEl); 
            }); 
        } else { 
            mapa = GAME_DATA.MAP_DATA[currentState]?.grid; 
        } 
        if (!mapa) { return; }
        mapa.forEach((row, y) => { 
            row.forEach((tileId, x) => { 
                const tile = document.createElement('div'); 
                tile.className = 'tile'; 
                tile.style.left = `${x * TILE_SIZE}px`; 
                tile.style.top = `${y * TILE_SIZE}px`; 
                if (tileId === 1) tile.style.backgroundColor = 'var(--wall-color)';
                else if (tileId === 9) { tile.style.backgroundColor = 'var(--save-crystal-color)'; tile.classList.add('crystal-shape'); }
                else if (currentState === 'CASA' || currentState === 'CIDADE') { 
                    if (tileId === 2) tile.style.backgroundColor = 'var(--door-color)'; 
                    else if (tileId === 6) { tile.style.backgroundColor = 'var(--dungeon-entrance-color)'; tile.classList.add('crystal-shape'); }
                    else if (tileId === 10) { tile.style.backgroundColor = 'var(--awakening-crystal-color)'; tile.classList.add('crystal-shape'); }
                    else if (tileId >= 20) {
                        const npcData = GAME_DATA.NPC_DATA.npcs.find(n => n.tileId === tileId);
                        if(npcData){
                            const npcEl = document.createElement('div');
                            npcEl.className = 'npc';
                            npcEl.style.left = `${x * TILE_SIZE}px`; 
                            npcEl.style.top = `${y * TILE_SIZE}px`; 
                            npcEl.style.backgroundColor = npcData.cor;
                            gameContainer.appendChild(npcEl);
                        }
                        tile.style.backgroundColor = 'var(--floor-color)';
                    }
                    else tile.style.backgroundColor = 'var(--floor-color)'; 
                } else if (currentState === 'MASMORRA') { 
                    if (tileId === 7) tile.style.backgroundColor = 'var(--exit-reset-color)'; 
                    else if (tileId === 8) tile.style.backgroundColor = 'var(--exit-next-color)'; 
                    else if (tileId === 11) { tile.style.backgroundColor = 'var(--teleport-crystal-color)'; tile.classList.add('crystal-shape'); }
                    else tile.style.backgroundColor = 'var(--dungeon-floor-color)'; 
                } 
                gameContainer.appendChild(tile); 
            }); 
        }); 
    }
    function desenharJogador() { 
        playerElement.style.left = `${player.x * TILE_SIZE}px`; 
        playerElement.style.top = `${player.y * TILE_SIZE}px`;
        playerElement.style.backgroundColor = player.playerColor;
        document.documentElement.style.setProperty('--player-color', player.playerColor);
        updateCamera();
    }
    function updateCamera() {
        const cameraX = -player.x * TILE_SIZE + viewport.offsetWidth / 2 - TILE_SIZE / 2;
        const cameraY = -player.y * TILE_SIZE + viewport.offsetHeight / 2 - TILE_SIZE / 2;
        gameContainer.style.transform = `translate(${cameraX}px, ${cameraY}px)`;
    }
    function logMessage(msg) { messageLog.innerHTML = msg; console.log(msg); }

    // =================================================================
    // LÓGICA DE MOVIMENTO E INTERAÇÃO
    // =================================================================
    function isPassable(x, y) {
        const currentState = getCurrentState();
        const mapa = (currentState === 'MASMORRA') ? masmorraAtual.mapa : GAME_DATA.MAP_DATA[currentState].grid;
        if (!mapa || !mapa[y] || mapa[y][x] === undefined) return false;

        const tileId = mapa[y][x];
        if (tileId === 1) return false;
        if (currentState === 'CIDADE' && tileId >= 20) return false;
        if (currentState === 'MASMORRA' && masmorraAtual.monstros.some(m => m.x === x && m.y === y)) return false;
        
        return true;
    }

    function moverJogador(dx, dy) {
        const currentState = getCurrentState();
        const canMove = ['CASA', 'CIDADE', 'MASMORRA'].includes(currentState);
        if (!canMove) return;
        const newX = player.x + dx; const newY = player.y + dy;
        if (currentState === 'MASMORRA') {
            const monstroColidido = masmorraAtual.monstros.find(m => m.x === newX && m.y === newY);
            if (monstroColidido) { iniciarCombate(monstroColidido); return; }
        }
        if (isPassable(newX, newY)) { player.x = newX; player.y = newY; desenharJogador(); }
    }

    function interagir() {
        const currentState = getCurrentState();
        const canInteract = ['CASA', 'CIDADE', 'MASMORRA'].includes(currentState);
        if (!canInteract) return;
        
        const mapa = (currentState === 'MASMORRA') ? masmorraAtual.mapa : GAME_DATA.MAP_DATA[currentState].grid;
        
        const direcoes = [{dx: 0, dy: -1}, {dx: 0, dy: 1}, {dx: -1, dy: 0}, {dx: 1, dy: 0}]; 
        for (const dir of direcoes) {
            const checkX = player.x + dir.dx;
            const checkY = player.y + dir.dy;
            if (mapa[checkY] && mapa[checkY][checkX] !== undefined) {
                const tileIdAdjacente = mapa[checkY][checkX];
                const npc = GAME_DATA.NPC_DATA.npcs.find(n => n.tileId === tileIdAdjacente);
                if (currentState === 'CIDADE' && npc) {
                    window[npc.action](); // Chama a função pelo nome (ex: "abrirLoja")
                    return;
                } else if (currentState === 'MASMORRA') {
                    const monstroAdjacente = masmorraAtual.monstros.find(m => m.x === checkX && m.y === checkY);
                    if (monstroAdjacente) { iniciarCombate(monstroAdjacente); return; }
                }
            }
        }

        const tileId = mapa[player.y][player.x];
        if (GAME_DATA.MAP_DATA[currentState]?.portais?.[tileId]) {
            const portal = GAME_DATA.MAP_DATA[currentState].portais[tileId];
            popState(); 
            pushState(portal.para); 
            player.x = portal.x; 
            player.y = portal.y; 
            desenharCenario(); 
            desenharJogador();
        } else if (currentState === 'CIDADE') {
            if (tileId === 6) { entrarNaMasmorra(1); }
            else if (tileId === 10) { abrirMenuRank(); }
        } else if (currentState === 'MASMORRA') {
            if (tileId === 11) { abrirMenuElevador(); return; }
            if (tileId === 7) { entrarNaMasmorra(masmorraAtual.nivel); } 
            else if (tileId === 8) { if (masmorraAtual.monstros.length === 0) { entrarNaMasmorra(masmorraAtual.nivel + 1); } else { logMessage("Derrote todos os monstros para avançar!"); } }
        }
    }

    // =================================================================
    // LÓGICA DE COMBATE, NÍVEL, RANK E PRESTÍGIO
    // =================================================================
    function gerarMonstro(nivel) {
        const config = GAME_DATA.MONSTER_DATA;
        const monstroTipo = config.types[Math.floor(Math.random() * config.types.length)];
        
        const minAtributos = config.statGeneration.basePointsFormula(nivel);
        const variacao = Math.floor(Math.random() * config.statGeneration.randomVariance);
        const pontosTotais = minAtributos + variacao;

        let atributos = { 
            vidaMax: 0, velocidade: 0, forcaFisica: 0, 
            inteligencia: 0, resistenciaFisica: 0, resistenciaMagica: 0 
        };

        atributos.vidaMax = Math.floor(pontosTotais * config.statGeneration.distribution.vidaMax);
        atributos.velocidade = Math.floor(pontosTotais * config.statGeneration.distribution.velocidade);
        let pontosCombateRestantes = pontosTotais - atributos.vidaMax - atributos.velocidade;
        
        const todosStatsCombate = ['forcaFisica', 'inteligencia', 'resistenciaFisica', 'resistenciaMagica'];
        const statsEspecializados = monstroTipo.specStats;
        const statsNaoEspecializados = todosStatsCombate.filter(stat => !statsEspecializados.includes(stat));
        const minPorStat = Math.floor(pontosTotais * config.statGeneration.distribution.minPerNonSpecStat);
        
        statsNaoEspecializados.forEach(stat => {
            atributos[stat] = minPorStat;
            pontosCombateRestantes -= minPorStat;
        });
        
        const pontosParaSpec = Math.floor(pontosCombateRestantes / statsEspecializados.length);
        statsEspecializados.forEach(stat => {
            atributos[stat] = pontosParaSpec;
        });
        
        let pontosDistribuidos = atributos.vidaMax + atributos.velocidade + (minPorStat * statsNaoEspecializados.length) + (pontosParaSpec * statsEspecializados.length);
        let sobra = pontosTotais - pontosDistribuidos;
        if (sobra > 0) {
            atributos[statsEspecializados[0]] += sobra;
        }
        atributos.vidaAtual = atributos.vidaMax;
        return {
            nome: `Triângulo ${monstroTipo.nome}`, nivel: nivel, pontosTotais: pontosTotais,
            tipoAtaque: monstroTipo.ataque, cor: monstroTipo.cor, atributos: atributos
        };
    }

    function verificarLevelUp() { 
        while (player.xp >= player.xpParaNivel) { 
            player.xp -= player.xpParaNivel; 
            player.nivel++; 
            player.xpParaNivel = GAME_DATA.PROGRESSION_SYSTEM.leveling.xpFormula(player.nivel); 
            player.pontosDeAtributo += GAME_DATA.PROGRESSION_SYSTEM.leveling.attributePointsPerLevel; 
            logMessage(`Você subiu para o Nível ${player.nivel}!`); 
            updateHUD(); 
        } 
    }
    
    function iniciarCombate(monstro) {
        pushState('COMBATE'); 
        currentEnemy = monstro;
        updateCombatUI();
        document.getElementById('combat-log-text').innerText = `Um ${currentEnemy.nome} (Nvl ${currentEnemy.nivel}) selvagem apareceu!`;
        if (calcularStatusTotais(player).velocidade >= currentEnemy.atributos.velocidade) {
            renderPlayerChoice();
        } else {
            document.getElementById('combat-log-text').innerText += `\nO inimigo é mais rápido e ataca primeiro.`;
            processTurn({ type: 'enemyFirst' });
        }
    }

    function renderPlayerChoice(message = "O que você vai fazer?") {
        fleeConfirmStep = 0;
        const combatMenu = document.getElementById('combat-menu');
        combatMenu.innerHTML = `
            <div class="combat-btn" id="combat-lutar">Lutar</div>
            <div class="combat-btn" id="combat-item">Itens</div>
            <div class="combat-btn" id="combat-info">Informações</div>
            <div class="combat-btn" id="combat-fugir">Fugir</div>
        `;
        document.getElementById('combat-lutar').onclick = renderAttackChoice;
        document.getElementById('combat-item').onclick = () => abrirInventario(true);
        document.getElementById('combat-info').onclick = showCombatInfo;
        document.getElementById('combat-fugir').onclick = handleFleeAttempt;

        document.getElementById('combat-log-text').innerText = message;
        document.getElementById('combat-advance-btn').style.display = 'none';
        combatMenu.style.display = 'grid';
    }

    function renderAttackChoice() {
        const combatMenu = document.getElementById('combat-menu');
        combatMenu.innerHTML = `
            <div class="combat-btn" id="combat-fisico">Ataque Físico</div>
            <div class="combat-btn" id="combat-magico">Ataque Mágico</div>
            <div class="combat-btn" id="combat-voltar">Voltar</div>
        `;
        document.getElementById('combat-fisico').onclick = () => processTurn({ type: 'attack', attackType: 'fisico' });
        document.getElementById('combat-magico').onclick = () => processTurn({ type: 'attack', attackType: 'magico' });
        document.getElementById('combat-voltar').onclick = renderPlayerChoice;
    }

    function processTurn(playerAction) {
        const combatMenu = document.getElementById('combat-menu');
        combatMenu.style.display = 'none';
        let combatMessage = "";

        if (playerAction.type === 'attack') {
            const skillAction = GAME_DATA.SKILL_DATA[playerAction.attackType][0].acao;
            combatMessage += skillAction(player, currentEnemy);
        } else if (playerAction.type === 'item') {
            const itemInfo = GAME_DATA.ITEM_DATA[playerAction.itemId];
            if (itemInfo && itemInfo.efeito) {
                combatMessage += itemInfo.efeito(player);
                const itemNoInventario = player.inventario.find(i => i.itemId === playerAction.itemId);
                if (itemNoInventario) itemNoInventario.quantidade--;
            }
        }
        updateCombatUI();

        if (currentEnemy.atributos.vidaAtual <= 0) {
            combatMessage += `\n\nVocê derrotou o ${currentEnemy.nome}!`;
            showCombatResult(combatMessage, true, true);
            return;
        }

        if (playerAction.type !== 'enemyFirst') {
            combatMessage += "\n\n--- Turno do Inimigo ---\n";
        }
        const enemySkillAction = GAME_DATA.SKILL_DATA[currentEnemy.tipoAtaque][0].acao;
        combatMessage += enemySkillAction(currentEnemy, player);
        updateCombatUI();

        if (calcularStatusTotais(player).vidaAtual <= 0) {
            combatMessage += `\n\nVocê foi derrotado!`;
            showCombatResult(combatMessage, true, false);
            return;
        }
        renderPlayerChoice(combatMessage);
    }

    function showCombatResult(message, isOver, isVictory) {
        document.getElementById('combat-log-text').innerText = message;
        const advanceBtn = document.getElementById('combat-advance-btn');
        advanceBtn.style.display = 'block';
        advanceBtn.onclick = () => {
            if (isOver) {
                terminarCombate(isVictory);
            } else {
                renderPlayerChoice();
            }
        };
    }

    function showCombatInfo() {
        const pStats = calcularStatusTotais(player);
        const eStats = currentEnemy.atributos;
        let infoMsg = `SEUS STATS:\nHP: ${Math.ceil(pStats.vidaAtual)}/${pStats.vidaMax} | Atq: ${pStats.forcaFisica} | Def: ${pStats.resistenciaFisica} | Spd: ${pStats.velocidade}\n\n`;
        infoMsg += `INIMIGO (${currentEnemy.nome}):\nHP: ${Math.ceil(eStats.vidaAtual)}/${eStats.vidaMax} | Atq: ${eStats.forcaFisica} | Def: ${eStats.resistenciaFisica} | Spd: ${eStats.velocidade}`;
        showCombatResult(infoMsg, false, null);
    }

    function terminarCombate(vitoria) {
        popState();
        if (vitoria) {
            const xpMultiplier = GAME_DATA.PROGRESSION_SYSTEM.xpMultiplierFormula(player);
            const xpGanho = GAME_DATA.COMBAT_FORMULAS.xpGainFormula(currentEnemy, xpMultiplier);
            player.xp += xpGanho;
            player.totalXpGanho += xpGanho;
            const gemasDropadas = GAME_DATA.COMBAT_FORMULAS.gemGainFormula(currentEnemy); 
            player.gemas += gemasDropadas;
            logMessage(`${currentEnemy.nome} derrotado! Você ganhou ${xpGanho} XP e ${gemasDropadas} Gemas!`);
            verificarLevelUp();
            masmorraAtual.monstros = masmorraAtual.monstros.filter(m => m.id !== currentEnemy.id);
            desenharCenario();
        } else {
            let logTxt = "Você foi derrotado! ";
            player.pontosDeAtributo = Math.max(0, player.pontosDeAtributo - 5);
            if (player.nivel > 1) {
                player.nivel--;
                logTxt += "Você perdeu 1 nível e 5 pontos de atributo. ";
            } else {
                logTxt += "Você perdeu 5 pontos de atributo. ";
            }

            player.xp = 0;
            player.xpParaNivel = GAME_DATA.PROGRESSION_SYSTEM.leveling.xpFormula(player.nivel);
            
            player.totalXpGanho = calcularXpParaNiveis(player.nivel); 

            logTxt += "Retornando para casa para se recuperar.";
            logMessage(logTxt);
            
            player.atributos.vidaAtual = calcularStatusTotais(player).vidaMax;
            gameStateStack = ['CASA']; 
            player.x = 2; 
            player.y = 2;
            desenharCenario(); 
            desenharJogador();
        }
        currentEnemy = null; updatePlayerStats();
    }
    
    function handleFleeAttempt() {
        const fleeBtn = document.getElementById('combat-fugir');
        if (fleeConfirmStep === 0) {
            fleeBtn.innerText = 'Tem certeza?';
            fleeConfirmStep++;
        } else if (fleeConfirmStep === 1) {
            fleeBtn.innerText = 'CONFIRMAR FUGA';
            fleeConfirmStep++;
        } else {
            tentarFugir();
        }
    }

    function tentarFugir() {
        const custoFuga = 1000;
        if (player.gemas < custoFuga) {
            renderPlayerChoice(`Gemas insuficientes para fugir! (Custo: ${custoFuga}).\nO que você vai fazer?`);
            return;
        }

        player.gemas -= custoFuga;
        logMessage(`Você pagou ${custoFuga} gemas e fugiu em segurança para sua casa.`);
        
        popState();
        currentEnemy = null;
        player.atributos.vidaAtual = calcularStatusTotais(player).vidaMax;
        gameStateStack = ['CASA']; 
        player.x = 2; 
        player.y = 2;
        desenharCenario(); 
        desenharJogador();
        updatePlayerStats();
    }

    function updateCombatUI() {
        if (!currentEnemy) return;
        const pStats = calcularStatusTotais(player);
        const eStats = currentEnemy.atributos;
        const setStat = (id, value) => document.getElementById(id).innerText = value;
        setStat('player-lvl', player.nivel);
        setStat('player-hp', `${Math.ceil(pStats.vidaAtual)}/${pStats.vidaMax}`);
        setStat('player-ata', pStats.forcaFisica);
        setStat('player-def', pStats.resistenciaFisica);
        setStat('player-esp-atq', pStats.inteligencia);
        setStat('player-esp-def', pStats.resistenciaMagica);
        setStat('player-spd', pStats.velocidade);
        setStat('enemy-lvl', currentEnemy.nivel);
        setStat('enemy-hp', `${Math.ceil(eStats.vidaAtual)}/${eStats.vidaMax}`);
        setStat('enemy-ata', eStats.forcaFisica);
        setStat('enemy-def', eStats.resistenciaFisica);
        setStat('enemy-esp-atq', eStats.inteligencia);
        setStat('enemy-esp-def', eStats.resistenciaMagica);
        setStat('enemy-spd', eStats.velocidade);
        document.getElementById('combat-enemy').style.borderBottomColor = currentEnemy.cor;
        document.getElementById('combat-player').style.backgroundColor = player.playerColor;
    }

    // =================================================================
    // LÓGICA DE UI E MENUS
    // =================================================================
    function abrirInventario(emCombate = false, abaInicial = 'cura') {
        pushState('INVENTARIO');
        
        const curaTab = document.getElementById('inv-tab-cura');
        const equipTab = document.getElementById('inv-tab-equip');
        const curaContent = document.getElementById('inventory-content-cura');
        const equipContent = document.getElementById('inventory-content-equip');
        
        function showTab(tabName) {
            if (tabName === 'cura') {
                curaTab.classList.add('active');
                equipTab.classList.remove('active');
                curaContent.style.display = 'block';
                equipContent.style.display = 'none';
                renderInventoryCura(emCombate);
            } else {
                curaTab.classList.remove('active');
                equipTab.classList.add('active');
                curaContent.style.display = 'none';
                equipContent.style.display = 'block';
                renderInventoryEquip();
            }
        }
        
        curaTab.onclick = () => showTab('cura');
        equipTab.onclick = () => showTab('equip');
        
        showTab(abaInicial);
    }

    function renderInventoryCura(emCombate) {
        const inventoryList = document.getElementById('inventory-content-cura');
        inventoryList.innerHTML = '';
        const itemsAtuais = player.inventario.filter(i => i.quantidade > 0);
        if (itemsAtuais.length === 0) { inventoryList.innerHTML = '<p>Vazio</p>'; return; }
        
        itemsAtuais.forEach(itemStack => {
            const itemInfo = GAME_DATA.ITEM_DATA[itemStack.itemId];
            const itemElement = document.createElement('div');
            itemElement.className = 'inventory-item';
            itemElement.innerText = `${itemInfo.nome} (x${itemStack.quantidade}) - ${itemInfo.descricao}`;
            itemElement.onclick = () => {
                if (emCombate) {
                    popState();
                    processTurn({ type: 'item', itemId: itemStack.itemId });
                } else {
                    if (itemInfo.efeito) {
                        logMessage(itemInfo.efeito(player));
                        itemStack.quantidade--;
                        updatePlayerStats();
                        renderInventoryCura(false);
                    }
                }
            };
            inventoryList.appendChild(itemElement);
        });
    }

    function renderInventoryEquip() {
        const inventoryList = document.getElementById('inventory-content-equip');
        inventoryList.innerHTML = '';
        const equippedIds = Object.values(player.equipamentos);
        const unequippedItems = player.inventarioEquipamentos.filter(e => !equippedIds.includes(e.id));
        
        if (unequippedItems.length === 0) { inventoryList.innerHTML = '<p>Nenhum equipamento no inventário.</p>'; return; }

        unequippedItems.forEach(equipInst => {
            const baseEquip = findEquipmentBase(equipInst.baseId);
            const habilidades = calcularStatsEquipamento(equipInst);
            let statsHtml = '';
            habilidades.forEach(hab => {
                const valorStr = hab.tipo === 'percentual' || hab.stat === 'rouboDeVidaPercentual' ? `${(hab.valor * 100).toFixed(1)}%` : Math.round(hab.valor);
                const formattedStatName = formatStatName(hab.stat);
                statsHtml += `${formattedStatName}: +${valorStr}<br>`;
            });

            const itemDiv = document.createElement('div');
            itemDiv.className = 'equip-item';
            itemDiv.innerHTML = `<strong>${baseEquip.nome} (Nvl. ${equipInst.level})</strong><br><small>${statsHtml}</small>`;
            itemDiv.onclick = () => abrirDetalhesItem(equipInst.id, 'INVENTARIO');
            inventoryList.appendChild(itemDiv);
        });
    }

    function fecharInventario() { popState(); }
    
    function abrirStatus() { 
        pushState('STATUS'); 
        const statusList = document.getElementById('status-list'); 
        statusList.innerHTML = '';
        const header = document.createElement('div');
        header.className = 'status-line';
        header.innerHTML = `<span>Pontos para distribuir:</span> <span id="status-pontos">${player.pontosDeAtributo}</span>`;
        statusList.appendChild(header);

        for (const [attr, value] of Object.entries(player.atributos)) { 
            if (attr === 'rouboDeVidaPercentual') continue;
            const line = document.createElement('div'); 
            line.className = 'status-line'; 
            line.id = `status-line-${attr}`;
            line.innerHTML = `<span>${formatStatName(attr)}:</span> <span id="status-val-${attr}">${Math.round(value)}</span>`; 
            const btnContainer = document.createElement('div');
            btnContainer.id = `status-btns-${attr}`;
            line.appendChild(btnContainer);
            statusList.appendChild(line); 
        } 
        const footer = document.createElement('div');
        footer.className = 'menu-option';
        footer.id = 'status-close';
        footer.innerText = 'Voltar';
        footer.onclick = fecharStatus;
        statusList.appendChild(footer);
        updateStatusUI();
    }
    
    function updateStatusUI() {
        if (getCurrentState() !== 'STATUS') return;
        document.getElementById('status-pontos').innerText = player.pontosDeAtributo;
        const baseAtributos = GAME_DATA.PLAYER_DEFAULTS.atributos;
        for (const attr in player.atributos) {
            if (attr === 'rouboDeVidaPercentual') continue;
            const valSpan = document.getElementById(`status-val-${attr}`);
            if(valSpan) valSpan.innerText = Math.round(player.atributos[attr]);

            const btnContainer = document.getElementById(`status-btns-${attr}`);
            if(btnContainer) {
                btnContainer.innerHTML = '';
                if (player.atributos[attr] > baseAtributos[attr] && !['vidaAtual'].includes(attr)) {
                    const minusBtn = document.createElement('button');
                    minusBtn.className = 'status-downgrade-btn';
                    minusBtn.innerText = '-';
                    minusBtn.onclick = () => removerPonto(attr);
                    btnContainer.appendChild(minusBtn);
                }
                if (player.pontosDeAtributo > 0 && !['vidaAtual'].includes(attr)) { 
                    const btn = document.createElement('button'); 
                    btn.className = 'status-upgrade-btn'; 
                    btn.innerText = '+'; 
                    btn.onclick = () => gastarPonto(attr); 
                    btnContainer.appendChild(btn); 
                } 
            }
        }
    }

    function fecharStatus() { popState(); }
    function gastarPonto(attr) { if (player.pontosDeAtributo > 0) { player.pontosDeAtributo--; player.atributos[attr]++; if (attr === 'vidaMax') player.atributos.vidaAtual++; updateStatusUI(); updatePlayerStats(); } }
    function removerPonto(attr) {
        if (player.atributos[attr] > GAME_DATA.PLAYER_DEFAULTS.atributos[attr]) {
            player.atributos[attr]--;
            player.pontosDeAtributo++;
            if (attr === 'vidaMax') {
                player.atributos.vidaAtual = Math.min(calcularStatusTotais(player).vidaAtual, calcularStatusTotais(player).vidaMax);
            }
            updateStatusUI();
            updatePlayerStats();
        }
    }

    function toggleMenu() { if (getCurrentState() === 'MENU') { fecharMenu(); } else if (['CASA', 'CIDADE', 'MASMORRA'].includes(getCurrentState())) { abrirMenu(); } }
    
    function abrirMenu() { 
        pushState('MENU'); 
        resetConfirmStep = 0;
        document.getElementById('menu-restart').innerText = 'Recomeçar';
    }
    
    function fecharMenu() { 
        popState(); 
        resetConfirmStep = 0;
        document.getElementById('menu-restart').innerText = 'Recomeçar';
    }
    
    function abrirLoja() { 
        pushState('LOJA');
        const shopList = document.getElementById('shop-list');
        shopList.innerHTML = '';
        GAME_DATA.SHOP_DATA.items.forEach(itemVenda => {
            const itemInfo = GAME_DATA.ITEM_DATA[itemVenda.itemId];
            const itemElement = document.createElement('div');
            itemElement.className = 'shop-item';
            itemElement.innerText = `Comprar ${itemInfo.nome} - ${itemVenda.preco} Gemas`;
            itemElement.onclick = () => confirmarCompra(itemVenda, itemElement);
            shopList.appendChild(itemElement);
        });
        updateShopUI();
    }

    function confirmarCompra(itemVenda, itemElement) {
        abrirLoja(); 
        const allItems = document.querySelectorAll('#shop-list .shop-item');
        const index = GAME_DATA.SHOP_DATA.items.findIndex(i => i.itemId === itemVenda.itemId);
        const targetElement = allItems[index];

        if (targetElement) {
            const itemInfo = GAME_DATA.ITEM_DATA[itemVenda.itemId];
            targetElement.innerHTML = `
                <span>${itemInfo.descricao}. Comprar por ${itemVenda.preco} Gemas?</span>
                <button class="shop-confirm-btn">Sim</button>
                <button class="shop-cancel-btn">Não</button>
            `;
            targetElement.onclick = null;
            targetElement.querySelector('.shop-confirm-btn').onclick = () => comprarItem(itemVenda.itemId, itemVenda.preco);
            targetElement.querySelector('.shop-cancel-btn').onclick = () => abrirLoja();
        }
    }

    function updateShopUI() { 
        if(getCurrentState() !== 'LOJA') return;
        const shopList = document.getElementById('shop-list');
        let header = document.getElementById('shop-header');
        if(!header) {
            header = document.createElement('div');
            header.id = 'shop-header';
            shopList.prepend(document.createElement('hr'));
            shopList.prepend(header);
        }
        header.innerHTML = `Suas Gemas: ${player.gemas}`;
    }

    function fecharLoja() { popState(); }
    
    function comprarItem(itemId, preco) { 
        if (player.gemas >= preco) { 
            player.gemas -= preco;
            const itemNoInventario = player.inventario.find(i => i.itemId === itemId);
            if (itemNoInventario) {
                itemNoInventario.quantidade++;
            } else {
                player.inventario.push({ itemId: itemId, quantidade: 1 });
            }
            logMessage(`Você comprou ${GAME_DATA.ITEM_DATA[itemId].nome}!`);
            abrirLoja();
        } else {
            logMessage("Gemas insuficientes!");
        }
    }

    function abrirMenuRank() {
        pushState('RANK');
        const rankInfo = document.getElementById('rank-info');
        const rankList = document.getElementById('rank-options-list');
        rankList.innerHTML = '';

        rankInfo.innerHTML = `<p>Rank Atual: ${player.rank || 'Nenhum'}</p><p>Prestígio: ${player.prestigio}</p><p>Nível: ${player.nivel}</p><p>Pontos: ${player.pontosDeAtributo}</p>`;

        if (player.rank === 0) {
            const awakenBtn = document.createElement('div');
            awakenBtn.className = 'rank-option';
            awakenBtn.innerText = 'Despertar Potencial (Grátis)';
            awakenBtn.onclick = () => despertarRank(false);
            rankList.appendChild(awakenBtn);
        } else {
            const rerollBtn = document.createElement('div');
            rerollBtn.className = 'rank-option';
            const rerollCostPoints = GAME_DATA.PROGRESSION_SYSTEM.rank.rerollCost.points;
            const rerollCostLevels = GAME_DATA.PROGRESSION_SYSTEM.rank.rerollCost.levels;
            rerollBtn.innerText = `Reavaliar Rank (Custo: ${rerollCostPoints} Pontos, ${rerollCostLevels} Níveis)`;
            
            if (player.pontosDeAtributo >= rerollCostPoints && player.nivel > rerollCostLevels) {
                rerollBtn.onclick = () => despertarRank(true);
            } else {
                rerollBtn.classList.add('disabled');
            }
            rankList.appendChild(rerollBtn);
        }

        const prestigeConfig = GAME_DATA.PROGRESSION_SYSTEM.prestige;
        const currentPrestige = player.prestigio;
        const nextPrestigeLevel = currentPrestige + 1;
        const req = prestigeConfig.requirements.find(r => r.prestigeLevel === nextPrestigeLevel) || prestigeConfig.requirements[prestigeConfig.requirements.length - 1];
        
        const reqLevel = req.requiredPlayerLevel;
        const costPoints = prestigeConfig.costFormula(reqLevel);

        const prestigeOption = document.createElement('div');
        prestigeOption.className = 'rank-option';
        prestigeOption.innerText = `Prestigiar (Próximo: ${nextPrestigeLevel}) - Req. Nível ${reqLevel}, Custo: ${costPoints} Pontos`;
        
        if (player.nivel >= reqLevel && player.pontosDeAtributo >= costPoints) {
            prestigeOption.onclick = prestigiar;
        } else {
            prestigeOption.classList.add('disabled');
        }
        rankList.appendChild(prestigeOption);
    }

    function fecharMenuRank() { popState(); }

    function despertarRank(isReroll) {
        const config = GAME_DATA.PROGRESSION_SYSTEM.rank;
        const rerollCostPoints = config.rerollCost.points;
        const rerollCostLevels = config.rerollCost.levels;

        if (isReroll && (player.pontosDeAtributo < rerollCostPoints || player.nivel <= rerollCostLevels)) {
            logMessage("Recursos insuficientes para reavaliar.");
            return;
        }

        const rand = Math.random();
        let newRank = 0;
        for(const prob of config.probabilities) {
            if (rand < prob.chance) {
                newRank = prob.rank;
                break;
            }
        }
        player.rank = newRank;
        
        if (isReroll) {
            player.pontosDeAtributo -= rerollCostPoints;
            player.nivel -= rerollCostLevels;
            player.xp = 0;
            player.xpParaNivel = GAME_DATA.PROGRESSION_SYSTEM.leveling.xpFormula(player.nivel);
            player.totalXpGanho = calcularXpParaNiveis(player.nivel);
            logMessage(`Você reavaliou seu potencial e despertou o Rank ${newRank}!`);
        } else {
            logMessage(`Você despertou seu potencial e alcançou o Rank ${newRank}!`);
        }
        updatePlayerStats();
        abrirMenuRank();
    }

    function prestigiar() {
        const prestigeConfig = GAME_DATA.PROGRESSION_SYSTEM.prestige;
        const currentPrestige = player.prestigio;
        const nextPrestigeLevel = currentPrestige + 1;
        const req = prestigeConfig.requirements.find(r => r.prestigeLevel === nextPrestigeLevel) || prestigeConfig.requirements[prestigeConfig.requirements.length - 1];
        
        const reqLevel = req.requiredPlayerLevel;
        const costPoints = prestigeConfig.costFormula(reqLevel);

        if (player.nivel >= reqLevel && player.pontosDeAtributo >= costPoints) {
            player.prestigio++;
            player.pontosDeAtributo -= costPoints;
            player.nivel = 1;
            player.xp = 0;
            player.xpParaNivel = GAME_DATA.PROGRESSION_SYSTEM.leveling.xpFormula(1);
            player.totalXpGanho = 0;
            logMessage(`Você alcançou o Prestígio ${player.prestigio}! Nível resetado. Bônus de XP aumentado.`);
            updatePlayerStats();
            fecharMenuRank();
        } else {
            logMessage("Requisitos não atendidos para prestigiar.");
        }
    }

    function abrirPerfil() {
        pushState('PERFIL');
        const profileInfo = document.getElementById('profile-info');
        profileInfo.innerHTML = `
            <div class="status-line"><span>Nível:</span> <span>${player.nivel}</span></div>
            <div class="status-line"><span>Rank:</span> <span>${player.rank || 'Não Despertado'}</span></div>
            <div class="status-line"><span>Prestígio:</span> <span>${player.prestigio}</span></div>
            <div class="status-line"><span>Andar Mais Alto:</span> <span>${player.andarMaisAlto}</span></div>
            <div class="status-line"><span>XP Total Adquirido:</span> <span>${player.totalXpGanho}</span></div>
            <div class="status-line"><span>Pontos de Atributo:</span> <span>${player.pontosDeAtributo}</span></div>
            <div class="status-line"><span>Gemas:</span> <span>${player.gemas}</span></div>
        `;
    }
    function fecharPerfil() { popState(); }

    // =================================================================
    // NOVAS FUNÇÕES DO ELEVADOR, NPCS E EDITOR
    // =================================================================
    function abrirMenuElevador() {
        pushState('ELEVADOR');
        const tabsContainer = document.getElementById('elevator-tabs');
        tabsContainer.innerHTML = '';

        if (player.andarMaisAlto === 0) {
            document.getElementById('elevator-floors').innerHTML = '<p>Explore a masmorra para liberar andares.</p>';
            return;
        }

        const totalTabs = Math.ceil(player.andarMaisAlto / 100);
        for (let i = totalTabs; i >= 1; i--) {
            const tab = document.createElement('div');
            tab.className = 'elevator-tab';
            const startFloor = (i - 1) * 100 + 1;
            const endFloor = i * 100;
            tab.innerText = `Andares ${startFloor}-${endFloor}`;
            tab.dataset.tabIndex = i;
            tab.onclick = () => renderizarAndaresElevador(i);
            tabsContainer.appendChild(tab);
        }
        
        renderizarAndaresElevador(totalTabs);
    }

    function renderizarAndaresElevador(tabIndex) {
        document.querySelectorAll('.elevator-tab').forEach(t => t.classList.remove('active'));
        const activeTab = document.querySelector(`.elevator-tab[data-tab-index='${tabIndex}']`);
        if(activeTab) activeTab.classList.add('active');

        const floorsContainer = document.getElementById('elevator-floors');
        floorsContainer.innerHTML = '';
        
        const startFloor = (tabIndex - 1) * 100 + 1;
        const endFloor = Math.min(tabIndex * 100, player.andarMaisAlto);

        for (let i = endFloor; i >= startFloor; i--) {
            if (i === player.andarMaisAlto || i % 5 === 0) {
                const option = document.createElement('div');
                option.className = 'elevator-option';
                option.innerText = `Ir para o Andar ${i}`;
                option.onclick = () => teleportarParaAndar(i);
                floorsContainer.appendChild(option);
            }
        }
    }

    function teleportarParaAndar(andar) {
        popState();
        entrarNaMasmorra(andar);
    }

    function retornarParaCidade() {
        popState();
        gameStateStack = ['CIDADE'];
        player.x = 9;
        player.y = 16;
        desenharCenario('CIDADE');
        desenharJogador();
        logMessage("Você retornou para a cidade.");
    }

    function abrirTutor() { 
        pushState('TUTOR'); 
        const content = document.getElementById('tutor-content');
        content.innerHTML = GAME_DATA.NPC_DATA.dialogues.tutor.texto;
    }

    function abrirColorChanger() {
        pushState('COLOR_CHANGER');
        document.getElementById('color-changer-content').innerHTML = `<h2>${GAME_DATA.NPC_DATA.dialogues.colorChanger.titulo}</h2><p>${GAME_DATA.NPC_DATA.dialogues.colorChanger.texto}</p>`;
        document.getElementById('color-changer-gemas').innerText = player.gemas;
        
        const rSlider = document.getElementById('red-slider');
        const gSlider = document.getElementById('green-slider');
        const bSlider = document.getElementById('blue-slider');
        const rValue = document.getElementById('red-value');
        const gValue = document.getElementById('green-value');
        const bValue = document.getElementById('blue-value');
        const preview = document.getElementById('color-preview');

        const currentColor = player.playerColor.startsWith('#') ? player.playerColor.substring(1) : player.playerColor;
        const currentR = parseInt(currentColor.substring(0, 2), 16);
        const currentG = parseInt(currentColor.substring(2, 4), 16);
        const currentB = parseInt(currentColor.substring(4, 6), 16);

        rSlider.value = currentR; rValue.innerText = currentR;
        gSlider.value = currentG; gValue.innerText = currentG;
        bSlider.value = currentB; bValue.innerText = currentB;

        function updatePreview() {
            const r = rSlider.value; const g = gSlider.value; const b = bSlider.value;
            rValue.innerText = r; gValue.innerText = g; bValue.innerText = b;
            preview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
        }

        rSlider.oninput = updatePreview;
        gSlider.oninput = updatePreview;
        bSlider.oninput = updatePreview;
        
        document.getElementById('color-confirm-btn').onclick = () => {
            const cost = 10000;
            if (player.gemas >= cost) {
                player.gemas -= cost;
                const r = parseInt(rSlider.value).toString(16).padStart(2, '0');
                const g = parseInt(gSlider.value).toString(16).padStart(2, '0');
                const b = parseInt(bSlider.value).toString(16).padStart(2, '0');
                player.playerColor = `#${r}${g}${b}`;
                desenharJogador();
                logMessage("Sua cor foi alterada!");
                popState();
            } else {
                logMessage("Gemas insuficientes!");
            }
        };
        updatePreview();
    }

    function abrirUpdateScreen() { pushState('UPDATE'); }

    // =================================================================
    // LÓGICA DE EQUIPAMENTOS, FORJA E MELHORIA
    // =================================================================
    function formatStatName(stat) {
        const names = {
            vidaMax: "Vida Máxima", vidaAtual: "Vida Atual", velocidade: "Velocidade",
            forcaFisica: "Força Física", inteligencia: "Inteligência",
            resistenciaFisica: "Resistência Física", resistenciaMagica: "Resistência Mágica",
            rouboDeVidaPercentual: "Roubo de Vida"
        };
        return names[stat] || stat;
    }

    function findEquipmentBase(baseId) {
        for (const equipType in GAME_DATA.EQUIPMENT_DATA) {
            if (GAME_DATA.EQUIPMENT_DATA[equipType][baseId]) {
                return GAME_DATA.EQUIPMENT_DATA[equipType][baseId];
            }
        }
        return null;
    }

    function calcularStatsEquipamento(equipInst) {
        const baseEquip = findEquipmentBase(equipInst.baseId);
        if (!baseEquip) return [];

        const habilidadesFinais = [];
        baseEquip.habilidadesBase.forEach((habBase, index) => {
            const scaling = baseEquip.levelUpScaling[index] || 0;
            const valorFinal = habBase.valor + (equipInst.level - 1) * scaling;
            habilidadesFinais.push({ stat: habBase.stat, valor: valorFinal, tipo: habBase.tipo });
        });
        return habilidadesFinais;
    }

    function calcularStatusTotais(entidade) {
        if (!entidade.atributos) return {};
        const totais = JSON.parse(JSON.stringify(entidade.atributos));
        const percentuais = {};

        for (const tipoSlot in entidade.equipamentos) {
            const equipInstId = entidade.equipamentos[tipoSlot];
            if (equipInstId) {
                const equipInst = entidade.inventarioEquipamentos.find(e => e.id === equipInstId);
                if (equipInst) {
                    const habilidades = calcularStatsEquipamento(equipInst);
                    habilidades.forEach(hab => {
                        if (hab.tipo === 'fixo') totais[hab.stat] = (totais[hab.stat] || 0) + hab.valor;
                        else if (hab.tipo === 'percentual') percentuais[hab.stat] = (percentuais[hab.stat] || 0) + hab.valor;
                    });
                }
            }
        }

        for (const stat in percentuais) {
            if (totais[stat]) totais[stat] *= (1 + percentuais[stat]);
        }
        
        for (const stat in totais) {
            if (stat !== 'rouboDeVidaPercentual') totais[stat] = Math.round(totais[stat]);
        }
        totais.vidaAtual = Math.min(entidade.atributos.vidaAtual, totais.vidaMax);
        return totais;
    }

    function abrirEquipScreen() {
        pushState('EQUIPAMENTOS');
        renderEquipScreen();
    }

    function renderEquipScreen() {
        const slotsContainer = document.getElementById('equip-slots-container');
        slotsContainer.innerHTML = '<h3>Equipado Atualmente</h3>';

        for (const tipoSlot in player.equipamentos) {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'equip-slot';
            const equipId = player.equipamentos[tipoSlot];

            if (equipId) {
                const equipInst = player.inventarioEquipamentos.find(e => e.id === equipId);
                const baseEquip = findEquipmentBase(equipInst.baseId);
                const habilidades = calcularStatsEquipamento(equipInst);
                
                let statsHtml = '';
                habilidades.forEach(hab => {
                    const valorStr = hab.tipo === 'percentual' || hab.stat === 'rouboDeVidaPercentual' ? `${(hab.valor * 100).toFixed(1)}%` : Math.round(hab.valor);
                    statsHtml += `${formatStatName(hab.stat)}: +${valorStr}<br>`;
                });
                
                slotDiv.innerHTML = `<strong>${baseEquip.nome} (Nvl. ${equipInst.level})</strong> - ${tipoSlot}<br><small>${statsHtml}</small>`;
                slotDiv.classList.add('filled');
                slotDiv.onclick = () => abrirDetalhesItem(equipId, 'EQUIPAMENTOS');
            } else {
                slotDiv.innerText = `${tipoSlot} Vazio`;
            }
            slotsContainer.appendChild(slotDiv);
        }
    }

    function abrirForja() {
        pushState('FORJA');
        const tabsContainer = document.getElementById('forja-tabs');
        tabsContainer.innerHTML = '';

        const tiposDeEquipamento = Object.keys(GAME_DATA.EQUIPMENT_DATA);
        const todasAbas = [...tiposDeEquipamento, 'Vender'];

        todasAbas.forEach((tipo, index) => {
            const tab = document.createElement('div');
            tab.className = 'oficina-tab';
            tab.innerText = tipo;
            tab.dataset.tipo = tipo;
            if (index === 0) tab.classList.add('active');
            tab.onclick = () => renderForjaTab(tipo);
            tabsContainer.appendChild(tab);
        });
        renderForjaTab(tiposDeEquipamento[0]);
    }

    function renderForjaTab(tipo) {
        document.querySelectorAll('#forja-tabs .oficina-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`#forja-tabs .oficina-tab[data-tipo='${tipo}']`).classList.add('active');
        
        const forjaContent = document.getElementById('forja-content');
        forjaContent.innerHTML = `<div class="status-line"><span>XP Total:</span> <span>${player.totalXpGanho}</span></div><div class="status-line"><span>Gemas:</span> <span>${player.gemas}</span></div><hr>`;

        if (tipo === 'Vender') {
            renderForjaVenda();
        } else {
            const equipamentosDoTipo = GAME_DATA.EQUIPMENT_DATA[tipo];
            for (const baseId in equipamentosDoTipo) {
                const equip = equipamentosDoTipo[baseId];
                const itemEl = document.createElement('div');
                itemEl.className = 'craft-item';
                itemEl.innerHTML = `Forjar <strong>${equip.nome}</strong><br><small>Custo: ${equip.custoXp} XP Total, ${equip.custoGemas} Gemas</small>`;
                itemEl.onclick = () => abrirDetalhesForja(baseId);
                forjaContent.appendChild(itemEl);
            }
        }
    }

    function renderForjaVenda() {
        const forjaContent = document.getElementById('forja-content');
        if (player.inventarioEquipamentos.length === 0) {
            forjaContent.innerHTML += '<p>Nenhum equipamento para vender.</p>';
            return;
        }

        player.inventarioEquipamentos.forEach(equipInst => {
            const baseEquip = findEquipmentBase(equipInst.baseId);
            if (!baseEquip) return;

            const valorVenda = Math.floor(baseEquip.custoGemas / 2);
            const itemEl = document.createElement('div');
            itemEl.className = 'craft-item';
            itemEl.innerHTML = `Vender <strong>${baseEquip.nome} (Nvl. ${equipInst.level})</strong><br><small>Receber: ${valorVenda} Gemas</small>`;
            itemEl.onclick = (e) => {
                e.stopPropagation();
                itemEl.innerHTML = `<span>Tem certeza que quer vender <strong>${baseEquip.nome}</strong> por ${valorVenda} Gemas?</span><button class="generic-confirm-btn">Sim</button><button class="generic-cancel-btn">Não</button>`;
                itemEl.onclick = null;
                itemEl.querySelector('.generic-confirm-btn').onclick = () => venderItem(equipInst.id);
                itemEl.querySelector('.generic-cancel-btn').onclick = () => renderForjaTab('Vender');
            };
            forjaContent.appendChild(itemEl);
        });
    }

    function venderItem(equipInstId) {
        const itemIndex = player.inventarioEquipamentos.findIndex(e => e.id === equipInstId);
        if (itemIndex === -1) return;

        const equipInst = player.inventarioEquipamentos[itemIndex];
        const baseEquip = findEquipmentBase(equipInst.baseId);
        if (!baseEquip) return;

        for (const slot in player.equipamentos) {
            if (player.equipamentos[slot] === equipInstId) player.equipamentos[slot] = null;
        }

        const valorVenda = Math.floor(baseEquip.custoGemas / 2);
        player.gemas += valorVenda;
        player.inventarioEquipamentos.splice(itemIndex, 1);

        logMessage(`Você vendeu ${baseEquip.nome} por ${valorVenda} Gemas.`);
        updatePlayerStats();
        renderForjaTab('Vender');
    }

    function abrirDetalhesForja(baseId) {
        pushState('FORJA_DETALHES');
        const equipBase = findEquipmentBase(baseId);
        const infoContainer = document.getElementById('forja-details-info');
        const optionsContainer = document.getElementById('forja-details-options');
        infoContainer.innerHTML = ''; optionsContainer.innerHTML = '';

        let statsHtml = '';
        equipBase.habilidadesBase.forEach(hab => {
            const valorStr = hab.tipo === 'percentual' || hab.stat === 'rouboDeVidaPercentual' ? `${(hab.valor * 100).toFixed(1)}%` : Math.round(hab.valor);
            statsHtml += `<p>${formatStatName(hab.stat)}: +${valorStr}</p>`;
        });

        infoContainer.innerHTML = `<h3>${equipBase.nome}</h3><h4>Atributos Base:</h4>${statsHtml}<hr><h4>Custos para Forjar:</h4><p>XP Total: ${equipBase.custoXp} (Seu: ${player.totalXpGanho})</p><p>Gemas: ${equipBase.custoGemas} (Sua: ${player.gemas})</p>`;

        const forgeBtn = document.createElement('div');
        forgeBtn.className = 'menu-option';
        forgeBtn.innerText = 'Forjar Item';
        
        if (player.totalXpGanho >= equipBase.custoXp && player.gemas >= equipBase.custoGemas) {
            forgeBtn.onclick = () => {
                forgeBtn.innerText = 'Tem certeza?';
                forgeBtn.onclick = () => forjarEquipamento(baseId);
            };
        } else {
            forgeBtn.classList.add('disabled');
        }
        optionsContainer.appendChild(forgeBtn);
    }

    function abrirDetalhesItem(equipInstId, fromScreen) {
        pushState('ITEM_DETALHES');
        renderDetalhesItem(equipInstId, fromScreen);
    }

    function renderDetalhesItem(equipInstId, fromScreen) {
        const equipInst = player.inventarioEquipamentos.find(e => e.id === equipInstId);
        if (!equipInst) { popState(); return; }

        const infoContainer = document.getElementById('item-details-info');
        const optionsContainer = document.getElementById('item-details-options');
        infoContainer.innerHTML = ''; optionsContainer.innerHTML = '';

        const baseEquip = findEquipmentBase(equipInst.baseId);
        const habilidades = calcularStatsEquipamento(equipInst);
        
        let statsHtml = '';
        habilidades.forEach(hab => {
            const valorStr = hab.tipo === 'percentual' || hab.stat === 'rouboDeVidaPercentual' ? `${(hab.valor * 100).toFixed(1)}%` : Math.round(hab.valor);
            statsHtml += `<p>Status: ${formatStatName(hab.stat)} +${valorStr}</p>`;
        });
        
        infoContainer.innerHTML += `<h3>${baseEquip.nome} (Nvl. ${equipInst.level})</h3>${statsHtml}`;

        const custoXp = Math.floor(baseEquip.custoMelhoriaXpInicial * Math.pow(1.25, equipInst.level - 1));
        const custoGemas = Math.floor(baseEquip.custoMelhoriaGemasInicial * Math.pow(1.1, equipInst.level - 1));
        const custoPontos = 1;
        infoContainer.innerHTML += `<h4>Custo para Melhorar:</h4><p>XP: ${custoXp} / ${player.xp}</p><p>Gemas: ${custoGemas} / ${player.gemas}</p><p>Pontos de Atributo: ${custoPontos} / ${player.pontosDeAtributo}</p>`;

        const isEquipped = Object.values(player.equipamentos).includes(equipInstId);
        
        if (fromScreen === 'INVENTARIO') {
            const equipBtn = document.createElement('div');
            equipBtn.className = 'menu-option';
            equipBtn.innerText = isEquipped ? 'Já Equipado' : 'Equipar';
            if (isEquipped) equipBtn.classList.add('disabled');
            else equipBtn.onclick = () => { equiparItem(equipInstId); popState(); abrirInventario(false, 'equip'); };
            optionsContainer.appendChild(equipBtn);
        } else if (fromScreen === 'EQUIPAMENTOS') {
            const unequipBtn = document.createElement('div');
            unequipBtn.className = 'menu-option';
            unequipBtn.innerText = 'Desequipar';
            unequipBtn.onclick = () => { desequiparItem(baseEquip.tipo); popState(); renderEquipScreen(); };
            optionsContainer.appendChild(unequipBtn);
        }

        const upgradeBtn = document.createElement('div');
        upgradeBtn.className = 'menu-option';
        upgradeBtn.innerText = 'Melhorar';
        if (player.xp >= custoXp && player.gemas >= custoGemas && player.pontosDeAtributo >= custoPontos) {
            upgradeBtn.onclick = () => melhorarEquipamento(equipInstId, fromScreen);
        } else {
            upgradeBtn.classList.add('disabled');
        }
        optionsContainer.appendChild(upgradeBtn);
    }

    function melhorarEquipamento(equipInstId, fromScreen) {
        const equipInst = player.inventarioEquipamentos.find(e => e.id === equipInstId);
        const baseEquip = findEquipmentBase(equipInst.baseId);

        const custoXp = Math.floor(baseEquip.custoMelhoriaXpInicial * Math.pow(1.25, equipInst.level - 1));
        const custoGemas = Math.floor(baseEquip.custoMelhoriaGemasInicial * Math.pow(1.1, equipInst.level - 1));
        const custoPontos = 1;
        
        if (player.xp >= custoXp && player.gemas >= custoGemas && player.pontosDeAtributo >= custoPontos) {
            player.xp -= custoXp;
            player.gemas -= custoGemas;
            player.pontosDeAtributo -= custoPontos;
            equipInst.level++;
            logMessage(`${baseEquip.nome} melhorado para o Nível ${equipInst.level}!`);
            updatePlayerStats();
            renderDetalhesItem(equipInstId, fromScreen);
        } else {
            logMessage("Recursos insuficientes para melhorar.");
        }
    }

    function equiparItem(equipInstId) {
        const equipInst = player.inventarioEquipamentos.find(e => e.id === equipInstId);
        const baseEquip = findEquipmentBase(equipInst.baseId);
        const tipoSlot = baseEquip.tipo;
        if (player.equipamentos[tipoSlot]) desequiparItem(tipoSlot, false); 
        player.equipamentos[tipoSlot] = equipInstId;
        logMessage(`${baseEquip.nome} equipado.`);
        updatePlayerStats();
    }

    function desequiparItem(tipoSlot, redraw = true) {
        const equipId = player.equipamentos[tipoSlot];
        if (equipId) {
            const equipInst = player.inventarioEquipamentos.find(e => e.id === equipId);
            const baseEquip = findEquipmentBase(equipInst.baseId);
            player.equipamentos[tipoSlot] = null;
            logMessage(`${baseEquip.nome} desequipado.`);
            updatePlayerStats();
        }
    }

    function forjarEquipamento(baseId) {
        const equipBase = findEquipmentBase(baseId);
        if(!equipBase || player.totalXpGanho < equipBase.custoXp || player.gemas < equipBase.custoGemas) {
            logMessage("Recursos insuficientes para forjar.");
            return;
        }

        const newTotalXp = player.totalXpGanho - equipBase.custoXp;
        let newLevel = 1;
        while (calcularXpParaNiveis(newLevel + 1) <= newTotalXp) newLevel++;
        const levelsLost = player.nivel - newLevel;
        const pointsCost = levelsLost > 0 ? levelsLost * GAME_DATA.PROGRESSION_SYSTEM.leveling.attributePointsPerLevel : 0;

        if (player.pontosDeAtributo < pointsCost) {
            logMessage(`Custo: ${pointsCost} pontos de atributo livres (você perderá ${levelsLost} nível(is)). Você tem ${player.pontosDeAtributo}.`);
            return;
        }

        player.totalXpGanho -= equipBase.custoXp;
        player.gemas -= equipBase.custoGemas;
        player.pontosDeAtributo -= pointsCost;
        player.nivel = newLevel;
        player.xpParaNivel = GAME_DATA.PROGRESSION_SYSTEM.leveling.xpFormula(player.nivel);
        player.xp = player.totalXpGanho - calcularXpParaNiveis(player.nivel);

        const novoEquip = { id: `eq-${Date.now()}`, baseId: baseId, level: 1 };
        player.inventarioEquipamentos.push(novoEquip);

        logMessage(`Você forjou ${equipBase.nome}!`);
        updatePlayerStats();
        popState();
        abrirForja();
    }

    function updatePlayerStats() { updateHUD(); if (getCurrentState() === 'COMBATE') { updateCombatUI(); } }
    function updateHUD() {
        const stats = calcularStatusTotais(player);
        document.getElementById('hud-level').innerText = `Nível: ${player.nivel}`;
        document.getElementById('hud-hp').innerText = `HP: ${Math.ceil(stats.vidaAtual)}/${stats.vidaMax}`;
        document.getElementById('hud-xp').innerText = `XP: ${player.xp}/${player.xpParaNivel}`;
        document.getElementById('hud-xp-multiplier').innerText = `XP Mult: ${GAME_DATA.PROGRESSION_SYSTEM.xpMultiplierFormula(player).toFixed(1)}x`;
    }
    
    // =================================================================
    // INICIALIZAÇÃO E CARREGAMENTO/SALVAMENTO
    // =================================================================
    function abrirMenuSalvar() { pushState('SAVE_LOAD'); }
    function fecharMenuSalvar() { popState(); }

    function baixarJogoCompleto() {
        const saveData = { player: JSON.parse(JSON.stringify(player)), masmorraAtual: masmorraAtual, gameStateStack: gameStateStack };
        saveData.player.x = 2;
        saveData.player.y = 2;
        saveData.gameStateStack = ['CASA'];
        const saveScript = document.createElement('script');
        saveScript.id = 'save-data-script';
        saveScript.innerHTML = `window.SAVED_GAME_DATA = ${JSON.stringify(saveData)};`;
        document.head.appendChild(saveScript);
        const htmlContent = document.documentElement.outerHTML;
        document.head.removeChild(saveScript);
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'legado-azul-save.html';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logMessage("Jogo completo salvo!");
    }

    function baixarSaveJSON() {
        const saveData = JSON.parse(JSON.stringify(player));
        saveData.x = 2;
        saveData.y = 2;
        const jsonData = JSON.stringify(saveData, null, 4);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'player_save.json';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logMessage("Save (JSON) baixado!");
    }
    
    function baixarJogoAtualizado() {
        let currentHtml = document.documentElement.outerHTML;
        const parser = new DOMParser();
        const doc = parser.parseFromString(currentHtml, 'text/html');

        const editorWrapper = document.getElementById('json-editors-wrapper');
        const editorTextareas = editorWrapper.getElementsByTagName('textarea');

        for (const editorTextarea of editorTextareas) {
            const key = editorTextarea.id.replace('editor-', '');
            const originalTextarea = doc.getElementById(`data-${key}`);
            if (originalTextarea) {
                // Pega o JSON formatado e minifica antes de salvar
                const formattedJson = editorTextarea.value;
                try {
                    const minifiedJson = JSON.stringify(JSON.parse(formattedJson));
                    originalTextarea.textContent = minifiedJson;
                } catch(e) {
                    logMessage(`ERRO: JSON inválido no editor ${key}. Não foi possível salvar.`);
                    console.error(`Erro de parse no editor ${key}`, e);
                    return;
                }
            }
        }
        
        const finalHtml = doc.documentElement.outerHTML;
        const blob = new Blob([finalHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'legado-azul-modificado.html';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logMessage("Novo HTML com dados atualizados foi baixado!");
    }

    function handleJsonUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const newPlayerData = JSON.parse(e.target.result);
                if (newPlayerData && newPlayerData.atributos && newPlayerData.nivel) {
                    player = newPlayerData;
                    logMessage("Save atualizado com sucesso via JSON!");
                    updatePlayerStats();
                    desenharCenario();
                    desenharJogador();
                } else {
                    logMessage("Erro: Arquivo JSON inválido.");
                }
            } catch (error) {
                logMessage("Erro ao ler o arquivo JSON.");
                console.error(error);
            }
        };
        reader.readAsText(file);
    }
    
    function handleEquipJsonUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const newEquipData = JSON.parse(e.target.result);
                if (typeof newEquipData === 'object') {
                    const editorTextarea = document.getElementById('editor-EQUIPMENT_DATA');
                    if(editorTextarea){
                        editorTextarea.value = JSON.stringify(newEquipData, null, 4);
                        logMessage("Dados de equipamento carregados no editor. Salve o HTML para aplicar.");
                    }
                } else {
                     logMessage("Erro: Arquivo JSON de equipamento inválido.");
                }
            } catch (error) {
                logMessage("Erro ao ler o arquivo JSON de equipamento.");
            }
        };
        reader.readAsText(file);
    }
    
    function recomecarJogo() {
        const restartBtn = document.getElementById('menu-restart');
        if (resetConfirmStep === 0) {
            restartBtn.innerText = 'Tem certeza?';
            resetConfirmStep++;
        } else if (resetConfirmStep === 1) {
            restartBtn.innerText = 'CONFIRMAR RECOMEÇO';
            resetConfirmStep++;
        } else {
            logMessage("Recomeçando o jogo...");
            player = JSON.parse(JSON.stringify(GAME_DATA.PLAYER_DEFAULTS));
            gameStateStack = ['CASA'];
            iniciarGameplay('CASA', player.x, player.y, ['CASA']);
            
            resetConfirmStep = 0;
            restartBtn.innerText = 'Recomeçar';
            fecharMenu();
        }
    }

    function iniciarNovoJogo() {
        player = JSON.parse(JSON.stringify(GAME_DATA.PLAYER_DEFAULTS)); 
        iniciarGameplay('CASA', player.x, player.y, ['CASA']);
        logMessage("O jogo começou! Use o menu para distribuir seus pontos.");
    }

    function carregarJogo(saveData) {
        player = saveData.player;
        // Garantir compatibilidade com saves antigos
        if (player.equipamentos.Luva === undefined) player.equipamentos.Luva = null;
        if (player.equipamentos.Cordão === undefined) player.equipamentos.Cordão = null;
        masmorraAtual = saveData.masmorraAtual;
        logMessage("Jogo carregado com sucesso!");
        iniciarGameplay(saveData.gameStateStack[saveData.gameStateStack.length - 1], player.x, player.y, saveData.gameStateStack);
    }
    
    // Função auxiliar para calcular XP total baseado no nível (para saves antigos)
    function calcularXpParaNiveis(niveis) {
        if (niveis <= 1) return 0;
        let total = 0;
        for(let i = 1; i < niveis; i++) {
            total += GAME_DATA.PROGRESSION_SYSTEM.leveling.xpFormula(i);
        }
        return total;
    }

    function iniciarGameplay(startState, startX, startY, stack) {
        gameStateStack = stack;
        player.x = startX; player.y = startY;
        onStateChange(); 
        desenharCenario();
        desenharJogador();
        updatePlayerStats();
    }

    function init() {
        loadGameDataFromEditor(); // Carrega os dados antes de qualquer outra coisa

        document.getElementById('up-btn').onclick = () => moverJogador(0, -1);
        document.getElementById('down-btn').onclick = () => moverJogador(0, 1);
        document.getElementById('left-btn').onclick = () => moverJogador(-1, 0);
        document.getElementById('right-btn').onclick = () => moverJogador(1, 0);
        document.getElementById('action1-btn').onclick = interagir;
        document.getElementById('menu-btn').onclick = toggleMenu;
        
        document.getElementById('menu-close').onclick = fecharMenu;
        document.getElementById('inventory-close').onclick = fecharInventario;
        document.getElementById('shop-close').onclick = fecharLoja;
        document.getElementById('rank-close').onclick = fecharMenuRank;
        document.getElementById('profile-close').onclick = fecharPerfil;
        document.getElementById('save-load-close').onclick = fecharMenuSalvar;
        document.getElementById('equip-close').onclick = () => popState();
        document.getElementById('forja-close').onclick = () => popState();
        document.getElementById('forja-details-close').onclick = () => popState();
        document.getElementById('item-details-close').onclick = () => popState();
        document.getElementById('elevator-close').onclick = () => popState();
        document.getElementById('elevator-return-city').onclick = retornarParaCidade;
        document.getElementById('tutor-close').onclick = () => popState();
        document.getElementById('color-cancel-btn').onclick = () => popState();
        document.getElementById('update-close').onclick = () => popState();

        document.getElementById('menu-inventory').onclick = () => abrirInventario();
        document.getElementById('menu-status').onclick = () => abrirStatus();
        document.getElementById('menu-profile').onclick = abrirPerfil;
        document.getElementById('menu-save-load').onclick = abrirMenuSalvar;
        document.getElementById('menu-restart').onclick = recomecarJogo;
        document.getElementById('menu-equip').onclick = abrirEquipScreen;
        document.getElementById('menu-update').onclick = abrirUpdateScreen;
        
        document.getElementById('save-full-html').onclick = baixarJogoCompleto;
        document.getElementById('save-player-json').onclick = baixarSaveJSON;
        document.getElementById('download-updated-html-btn').onclick = baixarJogoAtualizado;
        document.getElementById('json-upload').addEventListener('change', handleJsonUpload);
        document.getElementById('equip-json-upload').addEventListener('change', handleEquipJsonUpload);
        
        if (window.SAVED_GAME_DATA) {
            document.getElementById('start-screen').style.display = 'none';
            carregarJogo(window.SAVED_GAME_DATA);
        } else {
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('start-btn').addEventListener('click', () => {
                document.getElementById('start-screen').style.display = 'none';
                iniciarNovoJogo();
            }, { once: true });
        }
    }

    window.onload = init;
    </script>


</body></html>
